<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- XLSX library from CDN -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- html2canvas for image capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #e5e7eb; /* Lighter text for dark bg */
            background-color: #111827; /* Fallback color */
        }

        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: blur(8px);
            -webkit-filter: blur(8px);
            z-index: -1;
            transition: background-image 0.5s ease-in-out;
        }

        /* Keyframe animations for a dynamic feel */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Apply animations to elements */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .fade-in-down { animation: fadeInDown 0.6s ease-out forwards; }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        .spinner { animation: spin 1s linear infinite; }
        .pulse-on-hover:hover {
            animation: pulse 0.5s ease-in-out;
        }

        /* Glassmorphism effect for cards */
        .glass-card {
            background: rgba(17, 24, 39, 0.7); /* Darker, less transparent background for better readability */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4338ca; }

        /* Date picker icon color */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Style for card being captured */
        .capturing-card {
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.7) !important; /* Teal glow */
            transition: box-shadow 0.2s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="background-container"></div>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef, useCallback, forwardRef } = React;
      
      // --- Reusable UI Components ---
      const Card = forwardRef(({ className = '', children, accentColor }, ref) => (
        <div 
          ref={ref}
          className={`rounded-2xl glass-card text-gray-200 transition-all duration-300 hover:shadow-2xl ${className}`}
          style={{ borderTop: `4px solid ${accentColor || 'transparent'}` }}
        >
          {children}
        </div>
      ));
      const CardHeader = ({ className = '', children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className}`}>{children}</div>;
      const CardTitle = ({ className = '', children }) => <h3 className={`text-xl font-bold leading-none tracking-tight text-gray-100 ${className}`}>{children}</h3>;
      const CardContent = ({ className = '', children }) => <div className={`p-6 pt-0 ${className}`}>{children}</div>;
      const Label = ({ className = '', children, htmlFor }) => <label className={`text-sm font-medium leading-none text-gray-300 ${className}`} htmlFor={htmlFor}>{children}</label>;
      
      const Input = ({ className = '', type = 'text', ...props }) => <input type={type} className={`h-10 w-full rounded-lg border border-gray-700 bg-black/20 px-3 py-2 text-sm text-gray-200 ring-offset-gray-900 file:border-0 file:text-sm file:font-medium placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-300 ${className}`} {...props} />;
      
      const SearchableInput = ({ value, onChange, options, id, placeholder }) => (
          <div className="relative">
              <Input list={id} value={value} onChange={onChange} placeholder={placeholder} className="w-full"/>
              <datalist id={id}>{options && options.map(option => <option key={option} value={option} />)}</datalist>
          </div>
      );

      const Button = ({ className = '', children, ...props }) => (
        <button className={`inline-flex items-center justify-center rounded-lg text-sm font-semibold ring-offset-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-to-r from-indigo-600 to-blue-500 text-white hover:from-indigo-700 hover:to-blue-600 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 h-10 px-4 py-2 ${className}`} {...props}>
          {children}
        </button>
      );

      const CollapsibleCard = ({ title, accentColor, children, onDownload, defaultMinimized = false, cardRef }) => {
          const [isMinimized, setIsMinimized] = useState(defaultMinimized);

          return (
              <Card accentColor={accentColor} ref={cardRef}>
                  <div className="flex items-center justify-between p-6">
                      <CardTitle className="cursor-pointer flex-1" onClick={() => setIsMinimized(!isMinimized)}>{title}</CardTitle>
                      <div className="flex items-center gap-2">
                        {onDownload && (
                            <button onClick={onDownload} title="Download this card as an image" className="text-teal-400 hover:text-teal-300 transition-colors p-1 rounded-full hover:bg-white/10">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        )}
                        <button onClick={() => setIsMinimized(!isMinimized)} className="text-indigo-400 hover:text-indigo-300 transition-transform duration-300 p-1" style={{ transform: isMinimized ? 'rotate(0deg)' : 'rotate(-180deg)' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                      </div>
                  </div>
                  <div className={`transition-all duration-500 ease-in-out overflow-hidden ${isMinimized ? 'max-h-0' : 'max-h-[1000px]'}`}>
                      <div className="p-6 pt-0">
                          {children}
                      </div>
                  </div>
              </Card>
          );
      };
      
      // --- Animated Components ---
      const AnimatedNumber = ({ value, isPercentage = false }) => {
          const [currentValue, setCurrentValue] = useState(0);
          const targetValue = useMemo(() => parseFloat(value) || 0, [value]);
          useEffect(() => {
              if (currentValue === targetValue) return;
              const duration = 1200;
              let startTimestamp = null;
              const step = (timestamp) => {
                  if (!startTimestamp) startTimestamp = timestamp;
                  const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                  const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                  const nextValue = easeOutCubic * targetValue;
                  setCurrentValue(nextValue);
                  if (progress < 1) {
                      requestAnimationFrame(step);
                  } else {
                      setCurrentValue(targetValue);
                  }
              };
              requestAnimationFrame(step);
          }, [targetValue]);
          const displayValue = isPercentage ? currentValue.toFixed(2) : Math.round(currentValue).toLocaleString();
          return <span>{displayValue}{isPercentage ? '%' : ''}</span>;
      };

      const BarChart = ({ data, barColor }) => {
          if (!data || data.length === 0) return <div className="flex items-center justify-center h-full text-gray-400">No data to display.</div>;
          const maxValue = Math.max(1, ...data.map(d => d.value));
          return (
              <div className="space-y-3 p-2 h-full">
                  {data.map((d, i) => (
                      <div key={i} className="grid grid-cols-12 gap-2 items-center fade-in-up" style={{ animationDelay: `${i * 120}ms`, opacity: 0 }}>
                          <div className="col-span-4 text-right text-sm text-gray-300 truncate pr-2 font-medium">{d.name}</div>
                          <div className="col-span-8 flex items-center">
                              <div className="w-full bg-white/10 rounded-full h-6 relative overflow-hidden">
                                  <div className="rounded-full h-6" style={{ width: `${(d.value / maxValue) * 100}%`, background: barColor, transition: 'width 1s cubic-bezier(0.25, 1, 0.5, 1)' }}></div>
                                  <span className="absolute inset-0 flex items-center justify-end text-xs font-bold text-white pr-3">{d.value}</span>
                              </div>
                          </div>
                      </div>
                  ))}
              </div>
          );
      };

      // --- Toast Notification Component ---
      const Toast = ({ message, type, onDismiss }) => {
          const [isExiting, setIsExiting] = useState(false);
          
          useEffect(() => {
              const timer = setTimeout(() => {
                  setIsExiting(true);
                  setTimeout(onDismiss, 300); // Wait for animation to finish
              }, 5000);

              return () => clearTimeout(timer);
          }, [onDismiss]);

          const baseClasses = "fixed top-5 right-5 w-full max-w-xs p-4 rounded-lg shadow-lg text-white flex items-center z-50";
          const typeClasses = {
              success: 'bg-green-500',
              error: 'bg-red-500',
              info: 'bg-blue-500',
          };
          const animationClass = isExiting ? 'animate-[slideOutRight_0.3s_ease-out_forwards]' : 'animate-[slideInRight_0.3s_ease-out_forwards]';

          return (
              <div className={`${baseClasses} ${typeClasses[type] || typeClasses.info} ${animationClass}`}>
                  <div className="ml-3 text-sm font-medium">{message}</div>
                  <button onClick={onDismiss} className="ml-auto -mx-1.5 -my-1.5 bg-white/20 rounded-lg p-1.5 inline-flex h-8 w-8 text-white hover:bg-white/30">
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>
                  </button>
              </div>
          );
      };

      // --- Settings Page Component ---
      const SettingsView = ({ onBack, userSheets, onAddSheet, onDeleteSheet, cardVisibility, onVisibilityChange, backgroundOptions, currentBackground, onBackgroundChange, showToast }) => {
          const [newName, setNewName] = useState('');
          const [newUrl, setNewUrl] = useState('');
          const [editingUrl, setEditingUrl] = useState(null);

          const handleSaveClick = () => {
              if (newName.trim() && newUrl.trim()) {
                  if (editingUrl && editingUrl !== newUrl) {
                      onDeleteSheet(editingUrl);
                  }
                  onAddSheet(newName.trim(), newUrl.trim());
                  resetForm();
                  showToast('Sheet saved successfully!', 'success');
              } else {
                  showToast('Please provide both a name and a URL.', 'error');
              }
          };
          
          const handleEditClick = (url, name) => {
              setEditingUrl(url);
              setNewName(name);
              setNewUrl(url);
          };

          const resetForm = () => {
              setNewName('');
              setNewUrl('');
              setEditingUrl(null);
          };

          const handleCancelEdit = () => {
              resetForm();
          };

          return (
              <div className="max-w-4xl mx-auto space-y-8 fade-in p-4 sm:p-0">
                  <header className="flex items-center justify-between py-4">
                      <h1 className="text-3xl sm:text-4xl font-bold text-gray-100">Settings</h1>
                      <Button onClick={onBack} className="from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                          Back to Dashboard
                      </Button>
                  </header>

                  <Card>
                      <CardHeader><CardTitle>Appearance</CardTitle></CardHeader>
                      <CardContent>
                          <Label>Change Background</Label>
                          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-2">
                              {backgroundOptions.map(bg => (
                                  <div key={bg.name} onClick={() => onBackgroundChange(bg.url)} className={`relative rounded-lg overflow-hidden cursor-pointer aspect-video transition-all duration-200 ${currentBackground === bg.url ? 'ring-4 ring-indigo-500' : 'ring-2 ring-transparent hover:ring-indigo-400'}`}>
                                      <img src={bg.url} className="w-full h-full object-cover" alt={bg.name} />
                                      <div className="absolute inset-0 bg-black/30 flex items-end p-2">
                                          <p className="text-white text-sm font-semibold">{bg.name}</p>
                                      </div>
                                  </div>
                              ))}
                          </div>
                      </CardContent>
                  </Card>

                  <Card>
                      <CardHeader><CardTitle>Dashboard Visibility</CardTitle></CardHeader>
                      <CardContent>
                          <div className="grid grid-cols-2 gap-4">
                              {Object.entries(cardVisibility).map(([key, isVisible]) => (
                                  <label key={key} className="flex items-center space-x-3 cursor-pointer p-2 rounded-md hover:bg-white/5">
                                      <input type="checkbox" checked={isVisible} onChange={() => onVisibilityChange(key)} className="h-5 w-5 rounded border-gray-600 bg-gray-700 text-indigo-500 focus:ring-indigo-500" />
                                      <span className="text-base text-gray-300">
                                          {key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                                      </span>
                                  </label>
                              ))}
                          </div>
                      </CardContent>
                  </Card>
                  
                  <Card>
                      <CardHeader><CardTitle>Data Sources (Google Sheets)</CardTitle></CardHeader>
                      <CardContent>
                          <div className="space-y-4">
                              <div>
                                  <Label>Add or Update a Sheet</Label>
                                  <div className="mt-2 space-y-2">
                                      <Input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Sheet Name (e.g., 'My Team Sheet')" />
                                      <Input value={newUrl} onChange={e => setNewUrl(e.target.value)} placeholder="Public Google Sheet CSV URL" />
                                  </div>
                                  <div className="flex gap-2 mt-3">
                                      {editingUrl && <Button onClick={handleCancelEdit} className="w-full bg-gray-500 hover:bg-gray-600">Cancel Edit</Button>}
                                      <Button onClick={handleSaveClick} className="w-full">{editingUrl ? 'Update Sheet' : 'Add Sheet'}</Button>
                                  </div>
                              </div>
                              <div>
                                  <Label>Your Sheets</Label>
                                  <div className="space-y-2 max-h-40 overflow-y-auto mt-2">
                                      {Object.keys(userSheets).length === 0 ? (
                                          <p className="text-sm text-gray-400">You haven't added any custom sheets yet.</p>
                                      ) : (
                                          Object.entries(userSheets).map(([url, name]) => (
                                              <div key={url} className="flex items-center justify-between bg-gray-900/50 p-2 rounded-md">
                                                  <div className="truncate flex-1 mr-2">
                                                      <p className="font-medium text-gray-200 truncate">{name}</p>
                                                      <p className="text-xs text-gray-500 truncate">{url}</p>
                                                  </div>
                                                  <div className="flex items-center">
                                                      <button onClick={() => handleEditClick(url, name)} className="text-blue-400 hover:text-blue-300 p-1 rounded-full hover:bg-blue-900/50 transition-colors">
                                                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>
                                                      </button>
                                                      <button onClick={() => { onDeleteSheet(url); showToast('Sheet deleted.', 'info'); }} className="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-red-900/50 transition-colors">
                                                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                      </button>
                                                  </div>
                                              </div>
                                          ))
                                      )}
                                  </div>
                              </div>
                          </div>
                      </CardContent>
                  </Card>
              </div>
          );
      };
      
      // --- PIN Modal Component ---
      const PinModal = ({ isOpen, onClose, onSubmit, pin, setPin, error }) => {
          if (!isOpen) return null;

          const handleKeyPress = (e) => {
              if (e.key === 'Enter') {
                  onSubmit();
              }
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center fade-in">
                  <div className="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-sm m-4 fade-in-up" style={{animationDuration: '0.4s'}}>
                      <div className="flex justify-between items-center p-4 border-b border-gray-700">
                          <h2 className="text-xl font-bold text-gray-100">Enter PIN</h2>
                          <button onClick={onClose} className="text-gray-400 hover:text-gray-200 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                      </div>
                      <div className="p-6 space-y-4">
                          <Label htmlFor="pin-input">Please enter the 4-digit PIN to access settings.</Label>
                          <Input
                              id="pin-input"
                              type="password"
                              value={pin}
                              onChange={e => setPin(e.target.value)}
                              onKeyPress={handleKeyPress}
                              placeholder="****"
                              maxLength="4"
                              className="text-center text-2xl tracking-[1rem]"
                              autoFocus
                          />
                          {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                      </div>
                      <div className="p-4 bg-gray-900/50 rounded-b-xl">
                          <Button onClick={onSubmit} className="w-full">
                              Submit
                          </Button>
                      </div>
                  </div>
              </div>
          );
      };

      // --- Record Detail Modal ---
      const RecordDetailModal = ({ isOpen, onClose, record, findValue }) => {
          if (!isOpen || !record) return null;
          
          const DetailItem = ({ label, value }) => (
              <div>
                  <p className="text-sm font-medium text-gray-400">{label}</p>
                  <p className="text-base text-gray-200">{value || 'N/A'}</p>
              </div>
          );

          return (
              <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center fade-in" onClick={onClose}>
                  <div className="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl m-4 fade-in-up" style={{animationDuration: '0.4s'}} onClick={e => e.stopPropagation()}>
                      <div className="flex justify-between items-center p-4 border-b border-gray-700">
                          <h2 className="text-xl font-bold text-gray-100">Record Details</h2>
                          <button onClick={onClose} className="text-gray-400 hover:text-gray-200 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                      </div>
                      <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                              <DetailItem label="Calling Date & Time" value={findValue(record, ['Local Start Time'])} />
                              <DetailItem label="Calling Number" value={findValue(record, ['Calling Number'])} />
                              <DetailItem label="Audit Date" value={findValue(record, ['Audit Date'])} />
                              <DetailItem label="Agent ID" value={findValue(record, ['Evaluatee NT Login', 'Agent ID'])} />
                              <DetailItem label="TL Name" value={findValue(record, ['Team Leader', 'TL'])} />
                              <DetailItem label="Skill" value={findValue(record, ['Skill'])} />
                              <DetailItem label="QA Name" value={findValue(record, ['Evaluator Name', 'Auditor QA'])} />
                              <DetailItem label="CE Topic" value={findValue(record, ['CE Topic'])} />
                          </div>
                          <div className="grid grid-cols-3 gap-4">
                              <DetailItem label="NCE" value={findValue(record, ['NCE'])} />
                              <DetailItem label="CE" value={findValue(record, ['CE'])} />
                              <DetailItem label="RTC" value={findValue(record, ['STS', 'RTC'])} />
                          </div>
                          <div>
                              <p className="text-sm font-medium text-gray-400">QA Comments</p>
                              <p className="text-base text-gray-200 whitespace-pre-wrap break-words mt-1 bg-gray-900/50 p-3 rounded-md">{findValue(record, ['QA Comments']) || 'N/A'}</p>
                          </div>
                      </div>
                  </div>
              </div>
          );
      };
      
      // --- Detail View Component ---
      const DetailView = ({ data, title, onBack }) => {
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [selectedRecord, setSelectedRecord] = useState(null);
          const [searchTerm, setSearchTerm] = useState('');

          // Helper to find a value by trying multiple possible keys, ignoring case and whitespace.
          const findValue = (item, keys) => {
              if (!item) return null;
              const itemKeys = Object.keys(item);
              for (const searchKey of keys) {
                  const normalizedSearchKey = searchKey.trim().toLowerCase();
                  const actualKey = itemKeys.find(ik => ik.trim().toLowerCase() === normalizedSearchKey);
                  if (actualKey) {
                      return item[actualKey];
                  }
              }
              return null;
          };
          
          const filteredDetails = useMemo(() => {
              if (!searchTerm) return data;
              const lowercasedFilter = searchTerm.toLowerCase();
              return data.filter(item => {
                  const agentId = String(findValue(item, ['Evaluatee NT Login', 'Agent ID']) || '').toLowerCase();
                  const callingNumber = String(findValue(item, ['Calling Number']) || '').toLowerCase();
                  const qaName = String(findValue(item, ['Evaluator Name', 'Auditor QA']) || '').toLowerCase();
                  const qaComments = String(findValue(item, ['QA Comments']) || '').toLowerCase();
                  return agentId.includes(lowercasedFilter) || 
                         callingNumber.includes(lowercasedFilter) || 
                         qaName.includes(lowercasedFilter) || 
                         qaComments.includes(lowercasedFilter);
              });
          }, [data, searchTerm]);

          const handleRowClick = (record) => {
              setSelectedRecord(record);
              setIsModalOpen(true);
          };

          const handleDownload = () => {
              const exportData = filteredDetails.map(item => ({
                  "Calling date & time": findValue(item, ['Local Start Time']),
                  "Calling Number": findValue(item, ['Calling Number']),
                  "Audit Date": findValue(item, ['Audit Date']),
                  "Agent ID": findValue(item, ['Evaluatee NT Login', 'Agent ID']),
                  "TL Name": findValue(item, ['Team Leader', 'TL']),
                  "Skill": findValue(item, ['Skill']),
                  "QA Name": findValue(item, ['Evaluator Name', 'Auditor QA']),
                  "NCE": findValue(item, ['NCE']),
                  "CE": findValue(item, ['CE']),
                  "RTC": findValue(item, ['STS', 'RTC']),
                  "CE Topic": findValue(item, ['CE Topic']),
                  "QA Comments": findValue(item, ['QA Comments'])
              }));
              const worksheet = window.XLSX.utils.json_to_sheet(exportData);
              const workbook = window.XLSX.utils.book_new();
              window.XLSX.utils.book_append_sheet(workbook, worksheet, "Audit Details");
              window.XLSX.writeFile(workbook, "audit_details.xlsx");
          };

          const getStatusColor = (status) => {
              const lowerStatus = String(status || '').toLowerCase();
              if (lowerStatus === 'fail') return 'bg-red-900/50 text-red-300';
              if (lowerStatus === 'pass') return 'bg-green-900/50 text-green-300';
              if (lowerStatus === 'missing') return 'bg-yellow-900/50 text-yellow-300';
              return 'bg-gray-700 text-gray-300';
          };

          return (
              <>
                <RecordDetailModal 
                    isOpen={isModalOpen} 
                    onClose={() => setIsModalOpen(false)} 
                    record={selectedRecord}
                    findValue={findValue}
                />
                <div className="max-w-full mx-auto space-y-8 fade-in px-4 sm:px-0">
                    <header className="flex flex-col sm:flex-row items-start sm:items-center justify-between py-4 gap-4">
                        <h1 className="text-2xl sm:text-3xl font-bold text-gray-100 truncate">{title}</h1>
                        <div className="w-full sm:w-auto flex items-center gap-2">
                            <Input 
                                type="search"
                                placeholder="Search in details..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full sm:w-64"
                            />
                            <Button onClick={handleDownload} className="from-green-500 to-teal-400 hover:from-green-600 hover:to-teal-500 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 sm:mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                <span className="hidden sm:inline">Download</span>
                            </Button>
                            <Button onClick={onBack} className="from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 sm:mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                                <span className="hidden sm:inline">Back</span>
                            </Button>
                        </div>
                    </header>
                    <Card accentColor="#4f46e5">
                        <CardContent>
                            <div className="overflow-auto max-h-[75vh]">
                                <table className="w-full text-sm text-left text-gray-300">
                                    <thead className="text-xs text-gray-300 uppercase bg-white/5 sticky top-0 z-10">
                                        <tr>
                                            <th scope="col" className="px-4 py-3">Calling Date & Time</th>
                                            <th scope="col" className="px-4 py-3">Calling Number</th>
                                            <th scope="col" className="px-4 py-3">Audit Date</th>
                                            <th scope="col" className="px-4 py-3">Agent ID</th>
                                            <th scope="col" className="px-4 py-3">TL Name</th>
                                            <th scope="col" className="px-4 py-3">Skill</th>
                                            <th scope="col" className="px-4 py-3">QA Name</th>
                                            <th scope="col" className="px-4 py-3">NCE</th>
                                            <th scope="col" className="px-4 py-3">CE</th>
                                            <th scope="col" className="px-4 py-3">RTC</th>
                                            <th scope="col" className="px-4 py-3">CE Topic</th>
                                            <th scope="col" className="px-4 py-3">QA Comments</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredDetails.map((item, index) => {
                                            const nceStatus = findValue(item, ['NCE']) || 'N/A';
                                            const ceStatus = findValue(item, ['CE']) || 'N/A';
                                            const rtcStatus = findValue(item, ['STS', 'RTC']) || 'N/A';
                                            
                                            return (
                                                <tr key={index} className="border-b border-gray-800 hover:bg-white/5 cursor-pointer" onClick={() => handleRowClick(item)}>
                                                    <td className="px-4 py-4 font-medium text-gray-100 whitespace-nowrap">{findValue(item, ['Local Start Time']) || 'N/A'}</td>
                                                    <td className="px-4 py-4">{findValue(item, ['Calling Number']) || 'N/A'}</td>
                                                    <td className="px-4 py-4">{findValue(item, ['Audit Date']) || 'N/A'}</td>
                                                    <td className="px-4 py-4">{findValue(item, ['Evaluatee NT Login', 'Agent ID']) || 'N/A'}</td>
                                                    <td className="px-4 py-4">{findValue(item, ['Team Leader', 'TL']) || 'N/A'}</td>
                                                    <td className="px-4 py-4">{findValue(item, ['Skill']) || 'N/A'}</td>
                                                    <td className="px-4 py-4">{findValue(item, ['Evaluator Name', 'Auditor QA']) || 'N/A'}</td>
                                                    <td className="px-4 py-4"><span className={`inline-block text-xs font-semibold px-2.5 py-1 rounded-full ${getStatusColor(nceStatus)}`}>{nceStatus}</span></td>
                                                    <td className="px-4 py-4"><span className={`inline-block text-xs font-semibold px-2.5 py-1 rounded-full ${getStatusColor(ceStatus)}`}>{ceStatus}</span></td>
                                                    <td className="px-4 py-4"><span className={`inline-block text-xs font-semibold px-2.5 py-1 rounded-full ${getStatusColor(rtcStatus)}`}>{rtcStatus}</span></td>
                                                    <td className="px-4 py-4 max-w-xs truncate" title={findValue(item, ['CE Topic'])}>{findValue(item, ['CE Topic']) || 'N/A'}</td>
                                                    <td className="px-4 py-4 max-w-xs truncate" title={findValue(item, ['QA Comments'])}>{findValue(item, ['QA Comments']) || 'N/A'}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>
                </div>
              </>
          );
      };

      // --- Main App Component ---
      const App = () => {
        const defaultBackground = 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2071&auto=format&fit=crop';
        const backgroundOptions = [
            { name: 'Deep Forest', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2071&auto=format&fit=crop' },
            { name: 'Mountain Night', url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070&auto=format&fit=crop'},
            { name: 'Blue Abstract', url: 'https://images.unsplash.com/photo-1557682250-33bd709cbe85?q=80&w=2070&auto=format&fit=crop'},
            { name: 'Dark Waves', url: 'https://images.unsplash.com/photo-1536329583941-14287ec6fc4e?q=80&w=1980&auto=format&fit=crop'}
        ];

        const initialFilters = { evaluator: '', agentId: '', tlName: '', site: '', tenure: '', skill: '', startDate: '', endDate: '' };

        const [initialState] = useState(() => {
            try {
                const savedState = localStorage.getItem('auditDashboardState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState && typeof parsedState === 'object') {
                        // Ensure filters have all keys, even if saved state is from an older version
                        parsedState.filters = { ...initialFilters, ...parsedState.filters };
                        return parsedState;
                    }
                }
            } catch (e) {
                console.error("Failed to parse state from localStorage", e);
            }
            return {};
        });

        const [data, setData] = useState(initialState.data || []);
        const [filteredData, setFilteredData] = useState(initialState.data || []);
        const [filters, setFilters] = useState(initialState.filters || initialFilters);
        const [selectedFileName, setSelectedFileName] = useState(initialState.selectedFileName || null);
        const [googleSheetUrl, setGoogleSheetUrl] = useState(initialState.googleSheetUrl || "");
        const [customGoogleSheetUrl, setCustomGoogleSheetUrl] = useState(initialState.customGoogleSheetUrl || "");
        const [inputType, setInputType] = useState(initialState.inputType || null);
        
        const [isLoading, setIsLoading] = useState(false);
        const [isPinModalOpen, setIsPinModalOpen] = useState(false);
        const [pinInput, setPinInput] = useState('');
        const [pinError, setPinError] = useState('');
        const [auditorSortConfig, setAuditorSortConfig] = useState({ key: 'totalAudits', direction: 'descending' });
        const [tlSortConfig, setTlSortConfig] = useState({ key: 'totalAudits', direction: 'descending' });
        const [skillSortConfig, setSkillSortConfig] = useState({ key: 'totalAudits', direction: 'descending' });
        
        const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'detail', 'settings'
        const [detailData, setDetailData] = useState(null);
        const [detailTitle, setDetailTitle] = useState('');

        const [toast, setToast] = useState(null);
        
        // --- Refs for downloading individual cards ---
        const evaluatorCardRef = useRef(null);
        const tlCardRef = useRef(null);
        const skillCardRef = useRef(null);
        const ceHoldersCardRef = useRef(null);
        const nceHoldersCardRef = useRef(null);
        const ceTopicsCardRef = useRef(null);

        const showToast = useCallback((message, type = 'info') => {
            setToast({ id: Date.now(), message, type });
        }, []);

        const [currentBackground, setCurrentBackground] = useState(() => localStorage.getItem('dashboardBackground') || defaultBackground);

        useEffect(() => {
            document.getElementById('background-container').style.backgroundImage = `url('${currentBackground}')`;
            localStorage.setItem('dashboardBackground', currentBackground);
        }, [currentBackground]);

        useEffect(() => {
            if (data.length > 0) {
                const stateToSave = {
                    data,
                    filters,
                    selectedFileName,
                    googleSheetUrl,
                    customGoogleSheetUrl,
                    inputType,
                };
                try {
                    localStorage.setItem('auditDashboardState', JSON.stringify(stateToSave));
                } catch (e) {
                    console.error("Failed to save state to localStorage. Data might be too large.", e);
                }
            }
        }, [data, filters, selectedFileName, googleSheetUrl, customGoogleSheetUrl, inputType]);

        const [cardVisibility, setCardVisibility] = useState(() => {
            const savedVisibility = localStorage.getItem('cardVisibility');
            const defaultVisibility = {
                evaluatorPerformance: true,
                tlPerformance: true,
                skillPerformance: true,
                topCeHolders: true,
                topNceHolders: true,
                topCeTopics: true,
            };
            const loadedVisibility = savedVisibility ? JSON.parse(savedVisibility) : {};
            return { ...defaultVisibility, ...loadedVisibility };
        });

        useEffect(() => {
            localStorage.setItem('cardVisibility', JSON.stringify(cardVisibility));
        }, [cardVisibility]);

        const handleVisibilityChange = (cardKey) => {
            setCardVisibility(prev => ({ ...prev, [cardKey]: !prev[cardKey] }));
            showToast('Settings saved!', 'info');
        };
        
        const [userSheetOptions, setUserSheetOptions] = useState(() => {
            const oldArifSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQc-C8laLadVQw5LfI-liTMtWdUBURDuUmTmNRNHHuqZrC-vWVEwYJdvLh-YCaiUViMRepVXu9qP9qL/pub?gid=0&single=true&output=csv";
            const oldGpSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPOIS24AoFgLGukHhFXgOuDrm9XRDRKMADoFSNnYk8o4dAr3g0lTiEav898Ndfa-P4zJbewsouYnxz/pub?gid=0&single=true&output=csv";
            
            const newDefaultSheet = {
                "https://docs.google.com/spreadsheets/d/e/2PACX-1vSeOFrNqxNl56W4UmktKyP2lfl-Ficu_7edII44AImV_XKBqnIT-gmUjG2C2KbY4lyPDXYe0g1Mg7Cw/pub?gid=0&single=true&output=csv": "GP Sample Audit Sep'25"
            };

            try {
                const savedSheets = localStorage.getItem('userAuditSheets');
                let sheets = savedSheets ? JSON.parse(savedSheets) : newDefaultSheet;

                // Remove the old default sheets if they exist in the loaded data
                delete sheets[oldArifSheetUrl];
                delete sheets[oldGpSheetUrl];

                // If the list becomes empty after deletion, add the new default
                if (Object.keys(sheets).length === 0) {
                    sheets = newDefaultSheet;
                }

                return sheets;

            } catch (e) {
                console.error("Failed to parse user sheets from localStorage", e);
                return newDefaultSheet; // Fallback to the new default on error
            }
        });

        useEffect(() => {
            localStorage.setItem('userAuditSheets', JSON.stringify(userSheetOptions));
        }, [userSheetOptions]);

        const handleAddSheet = (name, url) => {
            setUserSheetOptions(prev => ({...prev, [url]: name}));
        };

        const handleDeleteSheet = (url) => {
            setUserSheetOptions(prev => {
                const newSheets = {...prev};
                delete newSheets[url];
                return newSheets;
            });
        };
        
        const handleSettingsClick = () => {
            setPinError('');
            setPinInput('');
            setIsPinModalOpen(true);
        };

        const handlePinSubmit = () => {
            if (pinInput === '1234') {
                setIsPinModalOpen(false);
                setCurrentView('settings');
                setPinInput('');
                setPinError('');
            } else {
                setPinError('Incorrect PIN. Please try again.');
                setPinInput('');
            }
        };

        const allSheetOptions = useMemo(() => ({
            "": "Select a Sheet",
            ...userSheetOptions,
            "custom": "Enter URL Manually..."
        }), [userSheetOptions]);

        // Helper to find a value by trying multiple possible keys, ignoring case and whitespace.
        const findValue = (item, keys) => {
            if (!item || typeof item !== 'object') return null;
            const itemKeys = Object.keys(item);
            for (const searchKey of keys) {
                const normalizedSearchKey = searchKey.trim().toLowerCase();
                const actualKey = itemKeys.find(ik => ik.trim().toLowerCase() === normalizedSearchKey);
                if (actualKey) {
                    return item[actualKey];
                }
            }
            return null;
        };

        const cascadingOptions = useMemo(() => {
            if (data.length === 0) {
                return { evaluators: [], agentIds: [], tlNames: [], sites: [], tenures: [], skills: [] };
            }

            const getOptionsFor = (fieldToGet, currentFilters) => {
                let tempFilteredData = data;
                const filterKeys = ['evaluator', 'agentId', 'tlName', 'site', 'tenure', 'skill'];
                const columnMap = {
                    evaluator: ['Evaluator Name', 'Auditor QA', 'Auditor'],
                    agentId: ['Evaluatee NT Login', 'Agent ID'],
                    tlName: ['Team Leader', 'TL'],
                    site: ['Site'],
                    tenure: ['Tenure 2'],
                    skill: ['Skill']
                };

                // Apply all filters *except* the one we're generating options for
                for (const key of filterKeys) {
                    if (key === fieldToGet || !currentFilters[key]) {
                        continue;
                    }
                    tempFilteredData = tempFilteredData.filter(item => {
                        const value = findValue(item, columnMap[key]);
                        const filterValue = currentFilters[key].toLowerCase();
                        const itemValue = value ? String(value).toLowerCase() : '';
                        return itemValue.includes(filterValue);
                    });
                }

                // From the now-filtered data, get the unique options for the target field
                const uniqueOptions = [...new Set(tempFilteredData.map(item => findValue(item, columnMap[fieldToGet])).filter(Boolean))];
                return uniqueOptions.sort();
            };

            return {
                evaluators: getOptionsFor('evaluator', filters),
                agentIds: getOptionsFor('agentId', filters),
                tlNames: getOptionsFor('tlName', filters),
                sites: getOptionsFor('site', filters),
                tenures: getOptionsFor('tenure', filters),
                skills: getOptionsFor('skill', filters),
            };
        }, [data, filters]);
      
        const clearFilters = useCallback(() => {
            setFilters(initialFilters);
        }, []);

        const processData = (workbook, sourceName) => {
            clearFilters(); // BUG FIX: Clear filters when new data is processed
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = window.XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });
            setData(json);
            setSelectedFileName(sourceName);
            showToast('Data loaded successfully!', 'success');
        };

        const handleFileUpload = (e) => {
          const file = e.target.files[0];
          if (file) {
            setIsLoading(true);
            setSelectedFileName(file.name);
            const reader = new FileReader();
            reader.onload = (evt) => {
              const bstr = evt.target.result;
              const workbook = window.XLSX.read(bstr, { type: 'binary' });
              processData(workbook, file.name);
              setIsLoading(false);
            };
            reader.readAsBinaryString(file);
          } else {
            setSelectedFileName(null);
          }
        };
        
        const handleUrlLoad = async (url) => {
            if (!url) { showToast("Please enter a URL.", "error"); return; }
            setIsLoading(true);
            setSelectedFileName(null);
            try {
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const csvText = await response.text();
                if (!csvText) throw new Error("Received empty response. Check if the sheet is public.");
                const workbook = window.XLSX.read(csvText, { type: 'string', raw: true });
                const sourceName = allSheetOptions[url] || url;
                processData(workbook, sourceName);
            } catch (err) {
                showToast(err.message || "Failed to fetch. Check URL and permissions.", "error");
                console.error(err);
            } finally {
                setIsLoading(false);
            }
        };

        const handleRefresh = () => {
            const urlToRefresh = googleSheetUrl === 'custom' ? customGoogleSheetUrl : googleSheetUrl;
            if (urlToRefresh) {
                showToast('Refreshing data...', 'info');
                handleUrlLoad(urlToRefresh);
            }
        };

        const handleClearFilters = () => {
            clearFilters();
            showToast('Filters cleared', 'info');
        };
        
        const handleReset = () => {
            setData([]);
            setFilteredData([]);
            handleClearFilters();
            setSelectedFileName(null);
            setGoogleSheetUrl('');
            setCustomGoogleSheetUrl('');
            setInputType(null);
            if(document.getElementById('file-upload')) {
               document.getElementById('file-upload').value = '';
            }
            localStorage.removeItem('auditDashboardState');
            showToast('Data and session have been reset.', 'info');
        };
        
        const handleInputTypeSelect = (type) => {
            setInputType(type);
            if (type === 'excel') {
                setGoogleSheetUrl(''); setCustomGoogleSheetUrl('');
            } else if (type === 'googleSheet') {
                setSelectedFileName(null);
                if(document.getElementById('file-upload')) {
                    document.getElementById('file-upload').value = '';
                }
            }
        };

        const handleDownloadImage = (elementRef, fileName) => {
            const element = elementRef.current;
            if (!element) return;
            
            showToast('Preparing image...', 'info');
            
            // Temporarily add a class for visual feedback and adjust height
            element.classList.add('capturing-card');
            const originalHeight = element.style.height;
            element.style.height = 'auto'; // Let content define height

            setTimeout(() => {
                window.html2canvas(element, {
                    backgroundColor: '#ffffff', // Set background to white for the capture
                    useCORS: true,
                    scale: 2 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${fileName.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    console.error("Image capture failed:", err);
                    showToast('Failed to create image.', 'error');
                }).finally(() => {
                    // Clean up: remove the class and restore original height
                    element.classList.remove('capturing-card');
                    element.style.height = originalHeight;
                });
            }, 200); // Increased delay slightly for style to apply
        };

        useEffect(() => {
          // New logic for what is considered an audited call
          let auditedData = data.filter(item => {
              const status = findValue(item, ['Status', 'Audit Status']);
              // A call is audited if Status is the boolean `true` or the string "True" (case-insensitive).
              return status === true || String(status).trim().toLowerCase() === 'true';
          });
          let filtered = auditedData;

          // Date Range Filter
          if (filters.startDate || filters.endDate) {
              const start = filters.startDate ? new Date(filters.startDate) : null;
              const end = filters.endDate ? new Date(filters.endDate) : null;
              if(start) start.setHours(0,0,0,0);
              if(end) end.setHours(23,59,59,999);

              filtered = filtered.filter(item => {
                  const auditDateStr = findValue(item, ['Audit Date']);
                  if (!auditDateStr) return false;
                  // Handle different date formats (e.g., MM/DD/YYYY, YYYY-MM-DD)
                  const auditDate = new Date(auditDateStr.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2'));
                  if (isNaN(auditDate.getTime())) return false; // Invalid date format in data

                  if (start && auditDate < start) return false;
                  if (end && auditDate > end) return false;
                  return true;
              });
          }

          if (filters.evaluator) filtered = filtered.filter(item => {
              const evaluator = findValue(item, ['Evaluator Name', 'Auditor QA', 'Auditor']);
              return evaluator && evaluator.toLowerCase().includes(filters.evaluator.toLowerCase());
          });
          if (filters.agentId) filtered = filtered.filter(item => {
              const agentId = findValue(item, ['Evaluatee NT Login', 'Agent ID']);
              return agentId && String(agentId).toLowerCase().includes(filters.agentId.toLowerCase());
          });
          if (filters.tlName) filtered = filtered.filter(item => {
              const tl = findValue(item, ['Team Leader', 'TL']);
              return tl && tl.toLowerCase().includes(filters.tlName.toLowerCase());
          });
          if (filters.site) filtered = filtered.filter(item => {
              const site = findValue(item, ['Site']);
              return site && site.toLowerCase().includes(filters.site.toLowerCase());
          });
          if (filters.tenure) filtered = filtered.filter(item => {
              const tenure = findValue(item, ['Tenure 2']);
              return tenure && tenure.toLowerCase().includes(filters.tenure.toLowerCase());
          });
          if (filters.skill) filtered = filtered.filter(item => {
              const skill = findValue(item, ['Skill']);
              return skill && skill.toLowerCase().includes(filters.skill.toLowerCase());
          });
          setFilteredData(filtered);
        }, [data, filters]);
      
        const handleViewDetails = () => {
            const titleParts = [];
            if (filters.evaluator) titleParts.push(`Evaluator: ${filters.evaluator}`);
            if (filters.agentId) titleParts.push(`Agent ID: ${filters.agentId}`);
            if (filters.tlName) titleParts.push(`TL: ${filters.tlName}`);
            // ... add other filters to title if needed
            let title = "Detailed Log";
            if (titleParts.length > 0) {
                title = `Details for ${titleParts.join(', ')}`;
            }

            setDetailData(filteredData);
            setDetailTitle(title);
            setCurrentView('detail');
        };

        const isDetailViewEnabled = useMemo(() => {
            const activeFilters = Object.values(filters).filter(val => val !== '').length;
            return activeFilters > 0 && filteredData.length > 0;
        }, [filters, filteredData]);
        
        // Final, more robust "failure-first" logic
        const isPassStatus = (value) => {
            // This function returns `true` for a PASS and `false` for a FAIL.
            // We explicitly define all possible FAILURE conditions. If a value does not match a failure condition, it's a PASS.
            
            // A ticked checkbox is read as boolean `true`, which is a FAILURE.
            if (value === true) {
                return false;
            }

            // Normalize all other values to a string to check against text-based failure conditions.
            const normalizedValue = String(value || '').trim().toLowerCase();
            
            // Define all strings that mean FAILURE.
            const failConditions = ['fail', 'missing', 'true', '✓'];
            
            if (failConditions.includes(normalizedValue)) {
                return false; // It's an explicit failure.
            }

            // If it's not an explicit failure, it's a PASS.
            // This correctly handles: boolean `false`, null, undefined, empty string, "pass", "false".
            return true;
        };

        const totalAudits = filteredData.length;
        
        // A failure is when the status is NOT a pass.
        const totalCE = filteredData.filter(item => !isPassStatus(findValue(item, ['CE']))).length;
        const totalNCE = filteredData.filter(item => !isPassStatus(findValue(item, ['NCE']))).length;
        
        // RTC Accuracy is the percentage of calls that ARE a pass.
        const totalRTCPass = filteredData.filter(item => isPassStatus(findValue(item, ['STS', 'RTC']))).length;
        
        const cePercentage = totalAudits > 0 ? ((totalCE / totalAudits) * 100) : 0;
        const ncePercentage = totalAudits > 0 ? ((totalNCE / totalAudits) * 100) : 0;
        const rtcPercentage = totalAudits > 0 ? ((totalRTCPass / totalAudits) * 100) : 0;
        
        const ceTopics = useMemo(() => {
            const topics = filteredData
                .filter(item => !isPassStatus(findValue(item, ['CE']))) // Updated logic
                .map(item => findValue(item, ['CE Topic']))
                .filter(topic => topic && topic !== 'N/A');

            const topicCounts = topics.reduce((acc, topic) => {
                acc[topic] = (acc[topic] || 0) + 1;
                return acc;
            }, {});

            return Object.entries(topicCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5)
                .map(([name, value]) => ({ name, value }));
        }, [filteredData]);

        const ceHolders = useMemo(() => Object.entries(filteredData.filter(item => !isPassStatus(findValue(item, ['CE']))).map(item => findValue(item, ['Evaluatee NT Login', 'Agent ID'])).reduce((acc, holder) => ({...acc, [holder]: (acc[holder] || 0) + 1 }), {})).sort(([,a],[,b]) => b-a).slice(0,5).map(([name, value]) => ({name, value})), [filteredData]);
        const nceHolders = useMemo(() => Object.entries(filteredData.filter(item => !isPassStatus(findValue(item, ['NCE']))).map(item => findValue(item, ['Evaluatee NT Login', 'Agent ID'])).reduce((acc, holder) => ({...acc, [holder]: (acc[holder] || 0) + 1 }), {})).sort(([,a],[,b]) => b-a).slice(0,5).map(([name, value]) => ({name, value})), [filteredData]);
        
        const requestSort = (key, config, setConfig) => {
            let direction = 'descending';
            if (config.key === key && config.direction === 'descending') {
                direction = 'ascending';
            }
            setConfig({ key, direction });
        };

        const auditorMetrics = useMemo(() => {
            const auditorData = filteredData.reduce((acc, item) => {
                const auditorName = findValue(item, ['Evaluator Name', 'Auditor QA', 'Auditor']);
                if (!auditorName) return acc;
                if (!acc[auditorName]) acc[auditorName] = { totalAudits: 0, totalCE: 0, totalNCE: 0, totalRTCPass: 0 };
                acc[auditorName].totalAudits++;
                if (!isPassStatus(findValue(item, ['CE']))) acc[auditorName].totalCE++;
                if (!isPassStatus(findValue(item, ['NCE']))) acc[auditorName].totalNCE++;
                if (isPassStatus(findValue(item, ['STS', 'RTC']))) {
                    acc[auditorName].totalRTCPass++;
                }
                return acc;
            }, {});

            let sortableItems = Object.entries(auditorData).map(([auditor, metrics]) => ({
                name: auditor,
                totalAudits: metrics.totalAudits,
                totalCE: metrics.totalCE,
                cePercentage: (metrics.totalAudits > 0 ? (metrics.totalCE / metrics.totalAudits) * 100 : 0),
                totalNCE: metrics.totalNCE,
                ncePercentage: (metrics.totalAudits > 0 ? (metrics.totalNCE / metrics.totalAudits) * 100 : 0),
                rtcAccuracy: (metrics.totalAudits > 0 ? (metrics.totalRTCPass / metrics.totalAudits) * 100 : 0),
            }));

            if (auditorSortConfig.key !== null) {
                sortableItems.sort((a, b) => {
                    if (a[auditorSortConfig.key] < b[auditorSortConfig.key]) {
                        return auditorSortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[auditorSortConfig.key] > b[auditorSortConfig.key]) {
                        return auditorSortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            return sortableItems;
        }, [filteredData, auditorSortConfig]);

        const tlMetrics = useMemo(() => {
            const tlData = filteredData.reduce((acc, item) => {
                const tlName = findValue(item, ['Team Leader', 'TL']);
                if (!tlName) return acc;
                if (!acc[tlName]) acc[tlName] = { totalAudits: 0, totalCE: 0, totalNCE: 0, totalRTCPass: 0 };
                acc[tlName].totalAudits++;
                if (!isPassStatus(findValue(item, ['CE']))) acc[tlName].totalCE++;
                if (!isPassStatus(findValue(item, ['NCE']))) acc[tlName].totalNCE++;
                if (isPassStatus(findValue(item, ['STS', 'RTC']))) {
                    acc[tlName].totalRTCPass++;
                }
                return acc;
            }, {});

            let sortableItems = Object.entries(tlData).map(([tl, metrics]) => ({
                name: tl,
                totalAudits: metrics.totalAudits,
                totalCE: metrics.totalCE,
                cePercentage: (metrics.totalAudits > 0 ? (metrics.totalCE / metrics.totalAudits) * 100 : 0),
                totalNCE: metrics.totalNCE,
                ncePercentage: (metrics.totalAudits > 0 ? (metrics.totalNCE / metrics.totalAudits) * 100 : 0),
                rtcAccuracy: (metrics.totalAudits > 0 ? (metrics.totalRTCPass / metrics.totalAudits) * 100 : 0),
            }));

            if (tlSortConfig.key !== null) {
                sortableItems.sort((a, b) => {
                    if (a[tlSortConfig.key] < b[tlSortConfig.key]) {
                        return tlSortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[tlSortConfig.key] > b[tlSortConfig.key]) {
                        return tlSortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            return sortableItems;
        }, [filteredData, tlSortConfig]);

        const skillMetrics = useMemo(() => {
            const skillData = filteredData.reduce((acc, item) => {
                const skillName = findValue(item, ['Skill']);
                if (!skillName) return acc;
                if (!acc[skillName]) acc[skillName] = { totalAudits: 0, totalCE: 0, totalNCE: 0 };
                acc[skillName].totalAudits++;
                if (!isPassStatus(findValue(item, ['CE']))) acc[skillName].totalCE++;
                if (!isPassStatus(findValue(item, ['NCE']))) acc[skillName].totalNCE++;
                return acc;
            }, {});

            let sortableItems = Object.entries(skillData).map(([skill, metrics]) => ({
                name: skill,
                totalAudits: metrics.totalAudits,
                totalCE: metrics.totalCE,
                cePercentage: (metrics.totalAudits > 0 ? (metrics.totalCE / metrics.totalAudits) * 100 : 0),
                totalNCE: metrics.totalNCE,
                ncePercentage: (metrics.totalAudits > 0 ? (metrics.totalNCE / metrics.totalAudits) * 100 : 0),
            }));

            if (skillSortConfig.key !== null) {
                sortableItems.sort((a, b) => {
                    if (a[skillSortConfig.key] < b[skillSortConfig.key]) {
                        return skillSortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[skillSortConfig.key] > b[skillSortConfig.key]) {
                        return skillSortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            return sortableItems;
        }, [filteredData, skillSortConfig]);

        const getAccentColor = (metric, value) => {
            switch (metric) {
                case 'total-audits': return '#4f46e5';
                case 'total-ce': return value > 1 ? '#ef4444' : '#10b981';
                case 'total-nce': return value > 10 ? '#f97316' : '#10b981';
                case 'rtc-accuracy': return value >= 90 ? '#10b981' : '#ef4444';
                default: return '#6b7280';
            }
        };
        const getTableCellColor = (value, threshold, isHigherBetter = false) => {
            const isBad = isHigherBetter ? parseFloat(value) < threshold : parseFloat(value) > threshold;
            return isBad ? 'text-red-400' : 'text-green-400';
        };
        
        const SortableHeader = ({ label, sortKey, sortConfig, setSortConfig }) => {
            const isSorted = sortConfig.key === sortKey;
            const icon = isSorted ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : '';
            return (
                <button onClick={() => requestSort(sortKey, sortConfig, setSortConfig)} className="flex items-center justify-center gap-2 font-semibold text-gray-300 hover:text-indigo-400 transition-colors">
                    <span>{label}</span>
                    <span className="text-indigo-400">{icon}</span>
                </button>
            );
        };
        
        if (currentView === 'detail') {
            return (
                <div className="p-4 sm:p-8">
                    <DetailView data={detailData} title={detailTitle} onBack={() => setCurrentView('dashboard')} />
                </div>
            );
        }

        if (currentView === 'settings') {
            return (
                <div className="p-4 sm:p-8">
                    <SettingsView 
                        onBack={() => setCurrentView('dashboard')}
                        userSheets={userSheetOptions}
                        onAddSheet={handleAddSheet}
                        onDeleteSheet={handleDeleteSheet}
                        cardVisibility={cardVisibility}
                        onVisibilityChange={handleVisibilityChange}
                        backgroundOptions={backgroundOptions}
                        currentBackground={currentBackground}
                        onBackgroundChange={setCurrentBackground}
                        showToast={showToast}
                    />
                </div>
            );
        }

        return (
          <div className="p-4 sm:p-8">
            {toast && <Toast key={toast.id} message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
            <PinModal 
                isOpen={isPinModalOpen} 
                onClose={() => setIsPinModalOpen(false)} 
                onSubmit={handlePinSubmit}
                pin={pinInput}
                setPin={setPinInput}
                error={pinError}
            />
            <div className="max-w-7xl mx-auto space-y-8">
              <header className="glass-card text-white p-6 rounded-2xl shadow-2xl fade-in-down relative">
                <div className="text-center">
                    <h1 className="text-4xl sm:text-5xl font-extrabold tracking-tight">Audit Dashboard</h1>
                    <p className="text-gray-300 mt-2 text-lg">Your data, beautifully visualized.</p>
                </div>
                <button onClick={handleSettingsClick} className="absolute top-4 right-4 text-white p-2 rounded-full hover:bg-white/10 transition-colors pulse-on-hover">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                
                <div className="mt-8 space-y-4">
                    <div className="flex items-center justify-center gap-6">
                        <div onClick={() => handleInputTypeSelect('excel')} className={`flex flex-col items-center justify-center p-4 w-44 h-32 rounded-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-1 ${inputType === 'excel' ? 'bg-white/20 ring-2 ring-white shadow-lg' : 'bg-white/5 hover:bg-white/10'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 7h.01M15 7h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            <span className="mt-2 font-semibold text-white">Excel File</span>
                        </div>
                        <div onClick={() => handleInputTypeSelect('googleSheet')} className={`flex flex-col items-center justify-center p-4 w-44 h-32 rounded-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-1 ${inputType === 'googleSheet' ? 'bg-white/20 ring-2 ring-white shadow-lg' : 'bg-white/5 hover:bg-white/10'}`}>
                           <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-3-3v6m-6 4h12a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                            <span className="mt-2 font-semibold text-white">Google Sheet</span>
                        </div>
                    </div>

                    {inputType === 'excel' && (
                        <div className="flex justify-center w-full max-w-md mx-auto pt-2 fade-in-up" style={{animationDuration: '0.3s'}}>
                            <Input id="file-upload" type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="cursor-pointer file:rounded-md file:bg-blue-500 file:border-0 file:text-white file:font-semibold file:text-sm file:py-2 file:px-4 hover:file:bg-blue-600"/>
                        </div>
                    )}

                    {inputType === 'googleSheet' && (
                        <div className="space-y-2 w-full max-w-xl mx-auto pt-2 fade-in-up" style={{animationDuration: '0.3s'}}>
                            <select value={googleSheetUrl} onChange={e => { const url = e.target.value; setGoogleSheetUrl(url); if (url !== "custom" && url !== "") { handleUrlLoad(url); }}} className="h-10 w-full rounded-md border border-gray-700 bg-black/20 px-3 py-2 text-sm text-gray-200 ring-offset-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                {Object.entries(allSheetOptions).map(([url, name]) => ( <option key={url} value={url} className="bg-gray-800 text-gray-200">{name}</option>))}
                            </select>
                            {googleSheetUrl === 'custom' && (
                                <div className="flex items-center justify-center gap-2 w-full fade-in-up" style={{animationDuration: '0.3s'}}>
                                    <Input type="text" value={customGoogleSheetUrl} onChange={e => setCustomGoogleSheetUrl(e.target.value)} placeholder="Paste public CSV URL and press Load" className="w-full"/>
                                    <Button onClick={() => handleUrlLoad(customGoogleSheetUrl)} className="flex-shrink-0">Load</Button>
                                </div>
                            )}
                        </div>
                    )}

                    {isLoading && (
                        <div className="flex items-center justify-center space-x-2 text-white mt-4">
                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full spinner"></div>
                            <span>Loading Data...</span>
                        </div>
                    )}
                    
                    {selectedFileName && !isLoading && (
                        <div className="flex items-center justify-center space-x-2 bg-black/30 p-2 rounded-lg max-w-md mx-auto mt-4">
                            <p className="text-sm text-white truncate">Loaded: <span className="font-semibold">{selectedFileName}</span></p>
                        </div>
                    )}
                </div>
              </header>
      
              {(data.length > 0 || isLoading) && (
                <main className="space-y-8 fade-in-up">
                  <Card accentColor="#4f46e5">
                    <CardHeader><CardTitle>Filter Your Data</CardTitle></CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                        <div className="space-y-1"><Label>Evaluator</Label>
                            <SearchableInput 
                                key={`evaluator-${cascadingOptions.evaluators.join('')}`}
                                id="evaluator-list" 
                                value={filters.evaluator} 
                                onChange={e => setFilters(p => ({...p, evaluator: e.target.value}))} 
                                options={cascadingOptions.evaluators} 
                                placeholder="Search Evaluator..."/>
                        </div>
                        <div className="space-y-1"><Label>Agent ID</Label>
                            <SearchableInput 
                                key={`agentId-${cascadingOptions.agentIds.join('')}`}
                                id="agent-list" 
                                value={filters.agentId} 
                                onChange={e => setFilters(p => ({...p, agentId: e.target.value}))} 
                                options={cascadingOptions.agentIds} 
                                placeholder="Search Agent ID..."/>
                        </div>
                        <div className="space-y-1"><Label>Team Leader</Label>
                            <SearchableInput 
                                key={`tlName-${cascadingOptions.tlNames.join('')}`}
                                id="tl-list" 
                                value={filters.tlName} 
                                onChange={e => setFilters(p => ({...p, tlName: e.target.value}))} 
                                options={cascadingOptions.tlNames} 
                                placeholder="Search TL Name..."/>
                        </div>
                        <div className="space-y-1"><Label>Site</Label>
                            <SearchableInput 
                                key={`site-${cascadingOptions.sites.join('')}`}
                                id="site-list" 
                                value={filters.site} 
                                onChange={e => setFilters(p => ({...p, site: e.target.value}))} 
                                options={cascadingOptions.sites} 
                                placeholder="Search Site..."/>
                        </div>
                        <div className="space-y-1"><Label>Tenure</Label>
                            <SearchableInput 
                                key={`tenure-${cascadingOptions.tenures.join('')}`}
                                id="tenure-list" 
                                value={filters.tenure} 
                                onChange={e => setFilters(p => ({...p, tenure: e.target.value}))} 
                                options={cascadingOptions.tenures} 
                                placeholder="Search Tenure..."/>
                        </div>
                        <div className="space-y-1"><Label>Skill</Label>
                            <SearchableInput 
                                key={`skill-${cascadingOptions.skills.join('')}`}
                                id="skill-list" 
                                value={filters.skill} 
                                onChange={e => setFilters(p => ({...p, skill: e.target.value}))} 
                                options={cascadingOptions.skills} 
                                placeholder="Search Skill..."/>
                        </div>
                        <div className="space-y-1"><Label htmlFor="start-date">Start Date</Label><Input id="start-date" type="date" value={filters.startDate} onChange={e => setFilters(p => ({...p, startDate: e.target.value}))} /></div>
                        <div className="space-y-1"><Label htmlFor="end-date">End Date</Label><Input id="end-date" type="date" value={filters.endDate} onChange={e => setFilters(p => ({...p, endDate: e.target.value}))} /></div>
                      </div>
                      <div className="mt-4 flex flex-wrap justify-end gap-4">
                          <Button onClick={handleViewDetails} disabled={!isDetailViewEnabled} className="from-green-500 to-teal-400 hover:from-green-600 hover:to-teal-500 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:opacity-70">
                              View Details
                          </Button>
                          <Button onClick={handleClearFilters} className="from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500">
                              Clear Filters
                          </Button>
                          {data.length > 0 && (
                            <>
                                <Button onClick={handleRefresh} disabled={inputType !== 'googleSheet'} className="from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:opacity-70">
                                    Refresh
                                </Button>
                                <Button onClick={handleReset} className="from-red-600 to-pink-500 hover:from-red-700 hover:to-pink-600">
                                    Reset Data
                                </Button>
                            </>
                          )}
                      </div>
                    </CardContent>
                  </Card>
      
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <Card accentColor={getAccentColor('total-audits')}><CardHeader><CardTitle>Total Audits</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-indigo-400"><AnimatedNumber value={totalAudits} /></div></CardContent></Card>
                    <Card accentColor={getAccentColor('total-ce', cePercentage)}><CardHeader><CardTitle>Total CE</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-red-400"><AnimatedNumber value={totalCE} /></div><p className="text-sm text-gray-400"><AnimatedNumber value={cePercentage} isPercentage={true} /></p></CardContent></Card>
                    <Card accentColor={getAccentColor('total-nce', ncePercentage)}><CardHeader><CardTitle>Total NCE</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-orange-400"><AnimatedNumber value={totalNCE} /></div><p className="text-sm text-gray-400"><AnimatedNumber value={ncePercentage} isPercentage={true} /></p></CardContent></Card>
                    <Card accentColor={getAccentColor('rtc-accuracy', rtcPercentage)}><CardHeader><CardTitle>RTC Accuracy</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-green-400"><AnimatedNumber value={rtcPercentage} isPercentage={true} /></div></CardContent></Card>
                  </div>
      
                  {cardVisibility.evaluatorPerformance && <CollapsibleCard 
                      title="Evaluator Performance Breakdown" 
                      accentColor="#3b82f6"
                      cardRef={evaluatorCardRef}
                      onDownload={() => handleDownloadImage(evaluatorCardRef, 'evaluator-performance')}
                    >
                      <div className="grid grid-cols-8 gap-4 px-4 py-2 border-b-2 border-gray-700 text-sm text-center">
                          <div className="text-left font-semibold text-gray-300 col-span-2">Evaluator</div>
                          <SortableHeader label="Total Audits" sortKey="totalAudits" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="CE Count" sortKey="totalCE" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="CE %" sortKey="cePercentage" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="NCE Count" sortKey="totalNCE" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="NCE %" sortKey="ncePercentage" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="RTC Acc %" sortKey="rtcAccuracy" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                      </div>
                      <div className="space-y-2 mt-2">
                          {auditorMetrics.map((auditor, index) => (
                              <div key={auditor.name} className="grid grid-cols-8 gap-4 items-center p-3 rounded-lg hover:bg-white/5 hover:shadow-md transition-all duration-200 fade-in-up" style={{ animationDelay: `${index * 50}ms`, opacity: 0 }}>
                                  <div className="col-span-2 flex items-center gap-3">
                                      <span className="font-bold text-indigo-300 bg-indigo-900/50 rounded-full w-8 h-8 flex items-center justify-center">{index + 1}</span>
                                      <span className="font-semibold text-gray-200 truncate">{auditor.name}</span>
                                  </div>
                                  <div className="text-center font-bold text-gray-300">{auditor.totalAudits}</div>
                                  <div className="text-center font-bold text-gray-300">{auditor.totalCE}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(auditor.cePercentage, 1)}`}>{auditor.cePercentage.toFixed(2)}%</div>
                                  <div className="text-center font-bold text-gray-300">{auditor.totalNCE}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(auditor.ncePercentage, 10)}`}>{auditor.ncePercentage.toFixed(2)}%</div>
                                  <div className={`text-center font-bold ${getTableCellColor(auditor.rtcAccuracy, 90, true)}`}>{auditor.rtcAccuracy.toFixed(2)}%</div>
                              </div>
                          ))}
                      </div>
                  </CollapsibleCard>}

                  {cardVisibility.tlPerformance && <CollapsibleCard 
                      title="TL Performance Breakdown" 
                      accentColor="#10b981"
                      cardRef={tlCardRef}
                      onDownload={() => handleDownloadImage(tlCardRef, 'tl-performance')}
                    >
                      <div className="grid grid-cols-8 gap-4 px-4 py-2 border-b-2 border-gray-700 text-sm text-center">
                          <div className="text-left font-semibold text-gray-300 col-span-2">Team Leader</div>
                          <SortableHeader label="Total Audits" sortKey="totalAudits" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="CE Count" sortKey="totalCE" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="CE %" sortKey="cePercentage" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="NCE Count" sortKey="totalNCE" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="NCE %" sortKey="ncePercentage" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="RTC Acc %" sortKey="rtcAccuracy" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                      </div>
                      <div className="space-y-2 mt-2">
                          {tlMetrics.map((tl, index) => (
                              <div key={tl.name} className="grid grid-cols-8 gap-4 items-center p-3 rounded-lg hover:bg-white/5 hover:shadow-md transition-all duration-200 fade-in-up" style={{ animationDelay: `${index * 50}ms`, opacity: 0 }}>
                                  <div className="col-span-2 flex items-center gap-3">
                                      <span className="font-bold text-green-300 bg-green-900/50 rounded-full w-8 h-8 flex items-center justify-center">{index + 1}</span>
                                      <span className="font-semibold text-gray-200 truncate">{tl.name}</span>
                                  </div>
                                  <div className="text-center font-bold text-gray-300">{tl.totalAudits}</div>
                                  <div className="text-center font-bold text-gray-300">{tl.totalCE}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(tl.cePercentage, 1)}`}>{tl.cePercentage.toFixed(2)}%</div>
                                  <div className="text-center font-bold text-gray-300">{tl.totalNCE}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(tl.ncePercentage, 10)}`}>{tl.ncePercentage.toFixed(2)}%</div>
                                  <div className={`text-center font-bold ${getTableCellColor(tl.rtcAccuracy, 90, true)}`}>{tl.rtcAccuracy.toFixed(2)}%</div>
                              </div>
                          ))}
                      </div>
                  </CollapsibleCard>}
                  
                  {cardVisibility.skillPerformance && <CollapsibleCard 
                      title="Skill Wise Performance" 
                      accentColor="#a855f7"
                      cardRef={skillCardRef}
                      onDownload={() => handleDownloadImage(skillCardRef, 'skill-performance')}
                    >
                      <div className="grid grid-cols-7 gap-4 px-4 py-2 border-b-2 border-gray-700 text-sm text-center">
                          <div className="text-left font-semibold text-gray-300 col-span-2">Skill</div>
                          <SortableHeader label="Total Audits" sortKey="totalAudits" sortConfig={skillSortConfig} setSortConfig={setSkillSortConfig} />
                          <SortableHeader label="CE Count" sortKey="totalCE" sortConfig={skillSortConfig} setSortConfig={setSkillSortConfig} />
                          <SortableHeader label="CE %" sortKey="cePercentage" sortConfig={skillSortConfig} setSortConfig={setSkillSortConfig} />
                          <SortableHeader label="NCE Count" sortKey="totalNCE" sortConfig={skillSortConfig} setSortConfig={setSkillSortConfig} />
                          <SortableHeader label="NCE %" sortKey="ncePercentage" sortConfig={skillSortConfig} setSortConfig={setSkillSortConfig} />
                      </div>
                      <div className="space-y-2 mt-2">
                          {skillMetrics.map((skill, index) => (
                              <div key={skill.name} className="grid grid-cols-7 gap-4 items-center p-3 rounded-lg hover:bg-white/5 hover:shadow-md transition-all duration-200 fade-in-up" style={{ animationDelay: `${index * 50}ms`, opacity: 0 }}>
                                  <div className="col-span-2 flex items-center gap-3">
                                      <span className="font-bold text-purple-300 bg-purple-900/50 rounded-full w-8 h-8 flex items-center justify-center">{index + 1}</span>
                                      <span className="font-semibold text-gray-200 truncate">{skill.name}</span>
                                  </div>
                                  <div className="text-center font-bold text-gray-300">{skill.totalAudits}</div>
                                  <div className="text-center font-bold text-gray-300">{skill.totalCE}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(skill.cePercentage, 1)}`}>{skill.cePercentage.toFixed(2)}%</div>
                                  <div className="text-center font-bold text-gray-300">{skill.totalNCE}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(skill.ncePercentage, 10)}`}>{skill.ncePercentage.toFixed(2)}%</div>
                              </div>
                          ))}
                      </div>
                  </CollapsibleCard>}

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {cardVisibility.topCeHolders && <CollapsibleCard 
                        title="Top 5 CE Holders" 
                        accentColor="#ef4444"
                        cardRef={ceHoldersCardRef}
                        onDownload={() => handleDownloadImage(ceHoldersCardRef, 'top-ce-holders')}
                      >
                        <div className="h-64"><BarChart data={ceHolders} barColor="linear-gradient(to right, #ef4444, #dc2626)" /></div>
                    </CollapsibleCard>}
                    {cardVisibility.topNceHolders && <CollapsibleCard 
                        title="Top 5 NCE Holders" 
                        accentColor="#f97316"
                        cardRef={nceHoldersCardRef}
                        onDownload={() => handleDownloadImage(nceHoldersCardRef, 'top-nce-holders')}
                      >
                        <div className="h-64"><BarChart data={nceHolders} barColor="linear-gradient(to right, #f97316, #fbbf24)" /></div>
                    </CollapsibleCard>}
                    {cardVisibility.topCeTopics && <CollapsibleCard 
                        title="Top 5 CE Topics" 
                        accentColor="#ef4444" 
                        cardRef={ceTopicsCardRef}
                        onDownload={() => handleDownloadImage(ceTopicsCardRef, 'top-ce-topics')}
                      >
                        <div className="h-64"><BarChart data={ceTopics} barColor="linear-gradient(to right, #ef4444, #dc2626)" /></div>
                    </CollapsibleCard>}
                  </div>
                </main>
              )}
              <footer className="text-center py-4 mt-4">
                  <div className="inline-block bg-black/30 text-gray-300 px-4 py-2 rounded-lg">
                      <p className="text-sm font-semibold" style={{ textShadow: '1px 1px 2px rgba(0,0,0,0.7)' }}>Created By MD Ariful Islam Khan</p>
                  </div>
              </footer>
            </div>
          </div>
        );
      };
      
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);

    </script>
</body>
</html>

