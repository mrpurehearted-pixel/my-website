<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #e5e7eb; /* Lighter text for dark bg */
            background-color: #111827; /* Fallback color */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: blur(8px);
            -webkit-filter: blur(8px);
            z-index: -1;
        }

        /* Keyframe animations for a dynamic feel */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Apply animations to elements */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .fade-in-down { animation: fadeInDown 0.6s ease-out forwards; }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        .spinner { animation: spin 1s linear infinite; }
        .pulse-on-hover:hover {
            animation: pulse 0.5s ease-in-out;
        }

        /* Glassmorphism effect for cards */
        .glass-card {
            background: rgba(17, 24, 39, 0.6); /* Darker, less transparent background for better readability */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4338ca; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;
      
      // --- Reusable UI Components ---
      const Card = ({ className = '', children, accentColor }) => (
        <div 
          className={`rounded-2xl glass-card text-gray-200 transition-all duration-300 hover:shadow-2xl ${className}`}
          style={{ borderTop: `4px solid ${accentColor || 'transparent'}` }}
        >
          {children}
        </div>
      );
      const CardHeader = ({ className = '', children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className}`}>{children}</div>;
      const CardTitle = ({ className = '', children }) => <h3 className={`text-xl font-bold leading-none tracking-tight text-gray-100 ${className}`}>{children}</h3>;
      const CardContent = ({ className = '', children }) => <div className={`p-6 pt-0 ${className}`}>{children}</div>;
      const Label = ({ className = '', children, htmlFor }) => <label className={`text-sm font-medium leading-none text-gray-300 ${className}`} htmlFor={htmlFor}>{children}</label>;
      
      const Input = ({ className = '', type = 'text', ...props }) => <input type={type} className={`h-10 w-full rounded-lg border border-gray-700 bg-black/20 px-3 py-2 text-sm text-gray-200 ring-offset-gray-900 file:border-0 file:text-sm file:font-medium placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-300 ${className}`} {...props} />;
      
      const SearchableInput = ({ value, onChange, options, id, placeholder }) => (
          <div className="relative">
              <Input list={id} value={value} onChange={onChange} placeholder={placeholder} className="w-full"/>
              <datalist id={id}>{options && options.map(option => <option key={option} value={option} />)}</datalist>
          </div>
      );

      const Button = ({ className = '', children, ...props }) => (
        <button className={`inline-flex items-center justify-center rounded-lg text-sm font-semibold ring-offset-white transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-to-r from-indigo-600 to-blue-500 text-white hover:from-indigo-700 hover:to-blue-600 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 h-10 px-4 py-2 ${className}`} {...props}>
          {children}
        </button>
      );

      const CollapsibleCard = ({ title, accentColor, children, defaultMinimized = false }) => {
          const [isMinimized, setIsMinimized] = useState(defaultMinimized);

          return (
              <Card accentColor={accentColor}>
                  <div className="flex items-center justify-between p-6 cursor-pointer" onClick={() => setIsMinimized(!isMinimized)}>
                      <CardTitle>{title}</CardTitle>
                      <button className="text-indigo-400 hover:text-indigo-300 transition-transform duration-300" style={{ transform: isMinimized ? 'rotate(0deg)' : 'rotate(-180deg)' }}>
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                          </svg>
                      </button>
                  </div>
                  <div className={`transition-all duration-500 ease-in-out overflow-hidden ${isMinimized ? 'max-h-0' : 'max-h-[1000px]'}`}>
                      <div className="p-6 pt-0">
                          {children}
                      </div>
                  </div>
              </Card>
          );
      };
      
      // --- Animated Components ---
      const AnimatedNumber = ({ value, isPercentage = false }) => {
          const [currentValue, setCurrentValue] = useState(0);
          const targetValue = useMemo(() => parseFloat(value) || 0, [value]);
          useEffect(() => {
              if (currentValue === targetValue) return;
              const duration = 1200;
              let startTimestamp = null;
              const step = (timestamp) => {
                  if (!startTimestamp) startTimestamp = timestamp;
                  const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                  const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                  const nextValue = easeOutCubic * targetValue;
                  setCurrentValue(nextValue);
                  if (progress < 1) {
                      requestAnimationFrame(step);
                  } else {
                      setCurrentValue(targetValue);
                  }
              };
              requestAnimationFrame(step);
          }, [targetValue]);
          const displayValue = isPercentage ? currentValue.toFixed(2) : Math.round(currentValue).toLocaleString();
          return <span>{displayValue}{isPercentage ? '%' : ''}</span>;
      };

      const BarChart = ({ data, barColor }) => {
          if (!data || data.length === 0) return <div className="flex items-center justify-center h-full text-gray-400">No data to display.</div>;
          const maxValue = Math.max(1, ...data.map(d => d.value));
          return (
              <div className="space-y-3 p-2 h-full">
                  {data.map((d, i) => (
                      <div key={i} className="grid grid-cols-12 gap-2 items-center fade-in-up" style={{ animationDelay: `${i * 120}ms`, opacity: 0 }}>
                          <div className="col-span-4 text-right text-sm text-gray-300 truncate pr-2 font-medium">{d.name}</div>
                          <div className="col-span-8 flex items-center">
                              <div className="w-full bg-white/10 rounded-full h-6 relative overflow-hidden">
                                  <div className="rounded-full h-6" style={{ width: `${(d.value / maxValue) * 100}%`, background: barColor, transition: 'width 1s cubic-bezier(0.25, 1, 0.5, 1)' }}></div>
                                  <span className="absolute inset-0 flex items-center justify-end text-xs font-bold text-white pr-3">{d.value}</span>
                              </div>
                          </div>
                      </div>
                  ))}
              </div>
          );
      };

      // --- Settings Modal Component ---
      const SettingsModal = ({ isOpen, onClose, userSheets, onAddSheet, onDeleteSheet, cardVisibility, onVisibilityChange }) => {
          if (!isOpen) return null;

          const [newName, setNewName] = useState('');
          const [newUrl, setNewUrl] = useState('');
          const [editingUrl, setEditingUrl] = useState(null);

          const handleSaveClick = () => {
              if (newName.trim() && newUrl.trim()) {
                  if (editingUrl && editingUrl !== newUrl) {
                      onDeleteSheet(editingUrl);
                  }
                  onAddSheet(newName.trim(), newUrl.trim());
                  resetForm();
              }
          };
          
          const handleEditClick = (url, name) => {
              setEditingUrl(url);
              setNewName(name);
              setNewUrl(url);
          };

          const resetForm = () => {
              setNewName('');
              setNewUrl('');
              setEditingUrl(null);
          };

          const handleCancelEdit = () => {
              resetForm();
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center fade-in">
                  <div className="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg m-4 fade-in-up" style={{animationDuration: '0.4s'}}>
                      <div className="flex justify-between items-center p-4 border-b border-gray-700">
                          <h2 className="text-xl font-bold text-gray-100">Settings</h2>
                          <button onClick={onClose} className="text-gray-400 hover:text-gray-200 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                      </div>
                      <div className="p-6 space-y-4">
                          <h3 className="font-semibold text-gray-200">Manage Google Sheets</h3>
                          <div className="space-y-2">
                              <Input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Sheet Name (e.g., 'My Team Sheet')" />
                              <Input value={newUrl} onChange={e => setNewUrl(e.target.value)} placeholder="Public Google Sheet CSV URL" />
                          </div>
                          <div className="flex gap-2">
                              {editingUrl && <Button onClick={handleCancelEdit} className="w-full bg-gray-500 hover:bg-gray-600">Cancel Edit</Button>}
                              <Button onClick={handleSaveClick} className="w-full">{editingUrl ? 'Update Sheet' : 'Add Sheet'}</Button>
                          </div>
                      </div>
                      <div className="p-6 border-t border-gray-700">
                          <h3 className="font-semibold text-gray-200 mb-2">Your Sheets</h3>
                          <div className="space-y-2 max-h-40 overflow-y-auto">
                              {Object.keys(userSheets).length === 0 ? (
                                  <p className="text-sm text-gray-400">You haven't added any custom sheets yet.</p>
                              ) : (
                                  Object.entries(userSheets).map(([url, name]) => (
                                      <div key={url} className="flex items-center justify-between bg-gray-700/50 p-2 rounded-md">
                                          <div className="truncate flex-1 mr-2">
                                              <p className="font-medium text-gray-200 truncate">{name}</p>
                                              <p className="text-xs text-gray-500 truncate">{url}</p>
                                          </div>
                                          <div className="flex items-center">
                                              <button onClick={() => handleEditClick(url, name)} className="text-blue-400 hover:text-blue-300 p-1 rounded-full hover:bg-blue-900/50 transition-colors">
                                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>
                                              </button>
                                              <button onClick={() => onDeleteSheet(url)} className="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-red-900/50 transition-colors">
                                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                              </button>
                                          </div>
                                      </div>
                                  ))
                              )}
                          </div>
                      </div>
                      <div className="p-6 border-t border-gray-700">
                          <h3 className="font-semibold text-gray-200 mb-2">Dashboard Visibility</h3>
                          <div className="grid grid-cols-2 gap-2">
                              {Object.entries(cardVisibility).map(([key, isVisible]) => (
                                  <label key={key} className="flex items-center space-x-2 cursor-pointer">
                                      <input type="checkbox" checked={isVisible} onChange={() => onVisibilityChange(key)} className="h-4 w-4 rounded border-gray-600 bg-gray-700 text-indigo-500 focus:ring-indigo-500" />
                                      <span className="text-sm text-gray-300">
                                          {key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                                      </span>
                                  </label>
                              ))}
                          </div>
                      </div>
                  </div>
              </div>
          );
      };
      
      // --- PIN Modal Component ---
      const PinModal = ({ isOpen, onClose, onSubmit, pin, setPin, error }) => {
          if (!isOpen) return null;

          const handleKeyPress = (e) => {
              if (e.key === 'Enter') {
                  onSubmit();
              }
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center fade-in">
                  <div className="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-sm m-4 fade-in-up" style={{animationDuration: '0.4s'}}>
                      <div className="flex justify-between items-center p-4 border-b border-gray-700">
                          <h2 className="text-xl font-bold text-gray-100">Enter PIN</h2>
                          <button onClick={onClose} className="text-gray-400 hover:text-gray-200 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                      </div>
                      <div className="p-6 space-y-4">
                          <Label htmlFor="pin-input">Please enter the 4-digit PIN to access settings.</Label>
                          <Input
                              id="pin-input"
                              type="password"
                              value={pin}
                              onChange={e => setPin(e.target.value)}
                              onKeyPress={handleKeyPress}
                              placeholder="****"
                              maxLength="4"
                              className="text-center text-2xl tracking-[1rem]"
                              autoFocus
                          />
                          {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                      </div>
                      <div className="p-4 bg-gray-900/50 rounded-b-xl">
                          <Button onClick={onSubmit} className="w-full">
                              Submit
                          </Button>
                      </div>
                  </div>
              </div>
          );
      };
      
      // --- Detail View Component ---
      const DetailView = ({ data, title, onBack }) => {
          // Helper to find a value by trying multiple possible keys, ignoring case and whitespace.
          const findValue = (item, keys) => {
              const itemKeys = Object.keys(item);
              for (const searchKey of keys) {
                  const normalizedSearchKey = searchKey.trim().toLowerCase();
                  const actualKey = itemKeys.find(ik => ik.trim().toLowerCase() === normalizedSearchKey);
                  if (actualKey) {
                      return item[actualKey];
                  }
              }
              return null;
          };

          const handleDownload = () => {
              const worksheet = window.XLSX.utils.json_to_sheet(data);
              const workbook = window.XLSX.utils.book_new();
              window.XLSX.utils.book_append_sheet(workbook, worksheet, "Audit Details");
              window.XLSX.writeFile(workbook, "audit_details.xlsx");
          };

          return (
              <div className="max-w-full mx-auto space-y-8 fade-in px-4 sm:px-0">
                  <header className="flex items-center justify-between py-4">
                      <h1 className="text-2xl sm:text-3xl font-bold text-gray-100 truncate">{title}</h1>
                       <div className="flex items-center gap-2">
                          <Button onClick={handleDownload} className="from-green-500 to-teal-400 hover:from-green-600 hover:to-teal-500 flex-shrink-0">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                              Download
                          </Button>
                          <Button onClick={onBack} className="from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 flex-shrink-0">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                              Back
                          </Button>
                      </div>
                  </header>
                  <Card accentColor="#4f46e5">
                      <CardContent>
                          <div className="overflow-auto max-h-[75vh]">
                              <table className="w-full text-sm text-left text-gray-300">
                                  <thead className="text-xs text-gray-300 uppercase bg-white/5 sticky top-0 z-10">
                                      <tr>
                                          <th scope="col" className="px-4 py-3">Site</th>
                                          <th scope="col" className="px-4 py-3">Audit Date</th>
                                          <th scope="col" className="px-4 py-3">Skill</th>
                                          <th scope="col" className="px-4 py-3">Calling Number</th>
                                          <th scope="col" className="px-4 py-3">Agent ID</th>
                                          <th scope="col" className="px-4 py-3">Hotline</th>
                                          <th scope="col" className="px-4 py-3">TL</th>
                                          <th scope="col" className="px-4 py-3">Auditor QA</th>
                                          <th scope="col" className="px-4 py-3">Tenure</th>
                                          <th scope="col" className="px-4 py-3">Errors</th>
                                          <th scope="col" className="px-4 py-3">Comments</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      {data.map((item, index) => {
                                          const isCE = findValue(item, ['CE']) === 'TRUE';
                                          const isNCE = findValue(item, ['NCE']) === 'TRUE';
                                          const isRTC = findValue(item, ['RTC']) === 'TRUE';
                                          
                                          return (
                                              <tr key={index} className="border-b border-gray-800 hover:bg-white/5">
                                                  <td className="px-4 py-4">{findValue(item, ['Site']) || 'N/A'}</td>
                                                  <td className="px-4 py-4 font-medium text-gray-100 whitespace-nowrap">{findValue(item, ['Audit date Mandatory']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['Skill']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['Calling Number', 'Number']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['Agent ID']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['Hotline']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['TL']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['Auditor QA']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">{findValue(item, ['Tenure 2']) || 'N/A'}</td>
                                                  <td className="px-4 py-4">
                                                      {isCE && <span className="inline-block bg-red-900/50 text-red-300 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">CE</span>}
                                                      {isNCE && <span className="inline-block bg-orange-900/50 text-orange-300 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">NCE</span>}
                                                      {isRTC && <span className="inline-block bg-yellow-900/50 text-yellow-300 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">RTC</span>}
                                                  </td>
                                                  <td className="px-4 py-4 max-w-xs truncate" title={findValue(item, ['QA Comments'])}>{findValue(item, ['QA Comments']) || 'N/A'}</td>
                                              </tr>
                                          );
                                      })}
                                  </tbody>
                              </table>
                          </div>
                      </CardContent>
                  </Card>
              </div>
          );
      };

      // --- Main App Component ---
      const App = () => {
        const [data, setData] = useState([]);
        const [filteredData, setFilteredData] = useState([]);
        const [filters, setFilters] = useState({ auditor: '', agentId: '', tlName: '', site: '', tenure: '', skill: '' });
        const [selectedFileName, setSelectedFileName] = useState(null);
        const [googleSheetUrl, setGoogleSheetUrl] = useState("");
        const [customGoogleSheetUrl, setCustomGoogleSheetUrl] = useState("");
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [inputType, setInputType] = useState(null);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isPinModalOpen, setIsPinModalOpen] = useState(false);
        const [pinInput, setPinInput] = useState('');
        const [pinError, setPinError] = useState('');
        const [auditorSortConfig, setAuditorSortConfig] = useState({ key: 'totalAudits', direction: 'descending' });
        const [tlSortConfig, setTlSortConfig] = useState({ key: 'totalAudits', direction: 'descending' });
        
        const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard' or 'detail'
        const [detailData, setDetailData] = useState(null);
        const [detailTitle, setDetailTitle] = useState('');

        const [cardVisibility, setCardVisibility] = useState(() => {
            const savedVisibility = localStorage.getItem('cardVisibility');
            const defaultVisibility = {
                auditorPerformance: true,
                tlPerformance: false,
                topCeHolders: true,
                topNceHolders: true,
                topNceTopics: false,
            };
            return savedVisibility ? JSON.parse(savedVisibility) : defaultVisibility;
        });

        useEffect(() => {
            localStorage.setItem('cardVisibility', JSON.stringify(cardVisibility));
        }, [cardVisibility]);

        const handleVisibilityChange = (cardKey) => {
            setCardVisibility(prev => ({ ...prev, [cardKey]: !prev[cardKey] }));
        };
        
        const [userSheetOptions, setUserSheetOptions] = useState(() => {
            const arifSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQc-C8laLadVQw5LfI-liTMtWdUBURDuUmTmNRNHHuqZrC-vWVEwYJdvLh-YCaiUViMRepVXu9qP9qL/pub?gid=0&single=true&output=csv";
            const defaultCustomSheet = { [arifSheetUrl]: "Arif's Sheet" };
            try {
                const savedSheets = localStorage.getItem('userAuditSheets');
                const parsedSheets = savedSheets ? JSON.parse(savedSheets) : {};
                return { ...defaultCustomSheet, ...parsedSheets };
            } catch (e) {
                console.error("Failed to parse user sheets from localStorage", e);
                return defaultCustomSheet;
            }
        });

        useEffect(() => {
            localStorage.setItem('userAuditSheets', JSON.stringify(userSheetOptions));
        }, [userSheetOptions]);

        const handleAddSheet = (name, url) => {
            setUserSheetOptions(prev => ({...prev, [url]: name}));
        };

        const handleDeleteSheet = (url) => {
            setUserSheetOptions(prev => {
                const newSheets = {...prev};
                delete newSheets[url];
                return newSheets;
            });
        };
        
        // --- NEW: EFFECT FOR SAVING APP STATE ---
        useEffect(() => {
            const stateToSave = {
                data,
                filters,
                selectedFileName,
                googleSheetUrl,
                customGoogleSheetUrl,
                inputType,
                auditorSortConfig,
                tlSortConfig,
                currentView,
                detailData,
                detailTitle,
            };
            try {
                localStorage.setItem('auditDashboardState', JSON.stringify(stateToSave));
            } catch (error) {
                console.warn("Could not save app state, possibly because data is too large for localStorage.", error);
                // Fallback: save state without the large 'data' array to avoid crashing.
                const { data, ...fallbackState } = stateToSave;
                localStorage.setItem('auditDashboardState', JSON.stringify(fallbackState));
            }
        }, [data, filters, selectedFileName, googleSheetUrl, customGoogleSheetUrl, inputType, auditorSortConfig, tlSortConfig, currentView, detailData, detailTitle]);

        // --- NEW: EFFECT FOR LOADING APP STATE ON INITIAL RENDER ---
        useEffect(() => {
            // This effect runs only once on initial load due to the empty dependency array [].
            try {
                const savedStateJSON = localStorage.getItem('auditDashboardState');
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    
                    // Restore each piece of state if it exists in the saved object
                    if (savedState.data) setData(savedState.data);
                    if (savedState.filters) setFilters(savedState.filters);
                    if (savedState.selectedFileName) setSelectedFileName(savedState.selectedFileName);
                    if (savedState.googleSheetUrl) setGoogleSheetUrl(savedState.googleSheetUrl);
                    if (savedState.customGoogleSheetUrl) setCustomGoogleSheetUrl(savedState.customGoogleSheetUrl);
                    if (savedState.inputType) setInputType(savedState.inputType);
                    if (savedState.auditorSortConfig) setAuditorSortConfig(savedState.auditorSortConfig);
                    if (savedState.tlSortConfig) setTlSortConfig(savedState.tlSortConfig);
                    if (savedState.currentView) setCurrentView(savedState.currentView);
                    if (savedState.detailData) setDetailData(savedState.detailData);
                    if (savedState.detailTitle) setDetailTitle(savedState.detailTitle);
                }
            } catch (error) {
                console.error("Failed to load or parse saved state from localStorage.", error);
                // If parsing fails, clear the corrupted state to start fresh next time.
                localStorage.removeItem('auditDashboardState');
            }
        }, []);


        const handleSettingsClick = () => {
            setPinError('');
            setPinInput('');
            setIsPinModalOpen(true);
        };

        const handlePinSubmit = () => {
            if (pinInput === '1234') {
                setIsPinModalOpen(false);
                setIsSettingsOpen(true);
                setPinInput('');
                setPinError('');
            } else {
                setPinError('Incorrect PIN. Please try again.');
                setPinInput('');
            }
        };

        const allSheetOptions = useMemo(() => ({
            "": "Select a Sheet",
            ...userSheetOptions,
            "custom": "Enter URL Manually..."
        }), [userSheetOptions]);

        // Helper to find a value by trying multiple possible keys, ignoring case and whitespace.
        const findValue = (item, keys) => {
            const itemKeys = Object.keys(item);
            for (const searchKey of keys) {
                const normalizedSearchKey = searchKey.trim().toLowerCase();
                const actualKey = itemKeys.find(ik => ik.trim().toLowerCase() === normalizedSearchKey);
                if (actualKey) {
                    return item[actualKey];
                }
            }
            return null;
        };

        const cascadingOptions = useMemo(() => {
            if (data.length === 0) {
                return { auditors: [], agentIds: [], tlNames: [], sites: [], tenures: [], skills: [] };
            }

            const getOptionsFor = (fieldToGet, currentFilters) => {
                let tempFilteredData = data;
                const filterKeys = ['auditor', 'agentId', 'tlName', 'site', 'tenure', 'skill'];
                const columnMap = {
                    auditor: ['Auditor QA', 'Auditor'],
                    agentId: ['Agent ID'],
                    tlName: ['TL'],
                    site: ['Site'],
                    tenure: ['Tenure 2'],
                    skill: ['Skill']
                };

                // Apply all filters *except* the one we're generating options for
                for (const key of filterKeys) {
                    if (key === fieldToGet || !currentFilters[key]) {
                        continue;
                    }
                    tempFilteredData = tempFilteredData.filter(item => {
                        const value = findValue(item, columnMap[key]);
                        // For agentId, we need to convert to string for `.includes` to work correctly
                        const filterValue = currentFilters[key].toLowerCase();
                        const itemValue = value ? String(value).toLowerCase() : '';
                        return itemValue.includes(filterValue);
                    });
                }

                // From the now-filtered data, get the unique options for the target field
                const uniqueOptions = [...new Set(tempFilteredData.map(item => findValue(item, columnMap[fieldToGet])).filter(Boolean))];
                return uniqueOptions.sort();
            };

            return {
                auditors: getOptionsFor('auditor', filters),
                agentIds: getOptionsFor('agentId', filters),
                tlNames: getOptionsFor('tlName', filters),
                sites: getOptionsFor('site', filters),
                tenures: getOptionsFor('tenure', filters),
                skills: getOptionsFor('skill', filters),
            };
        }, [data, filters]);
        
        const processData = (workbook, sourceName) => {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = window.XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });
            setData(json);
            setFilteredData(json);
            setSelectedFileName(sourceName);
            setError(null);
        };

        const handleFileUpload = (e) => {
          const file = e.target.files[0];
          if (file) {
            setData([]); setFilteredData([]);
            setIsLoading(true);
            setSelectedFileName(file.name);
            const reader = new FileReader();
            reader.onload = (evt) => {
              const bstr = evt.target.result;
              const workbook = window.XLSX.read(bstr, { type: 'binary' });
              processData(workbook, file.name);
              setIsLoading(false);
            };
            reader.readAsBinaryString(file);
          } else {
            setSelectedFileName(null);
          }
        };
        
        const handleUrlLoad = async (url) => {
            if (!url) { setError("Please enter a URL."); return; }
            setData([]); setFilteredData([]);
            setIsLoading(true);
            setError(null);
            setSelectedFileName(null);
            try {
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const csvText = await response.text();
                if (!csvText) throw new Error("Received empty response. Check if the sheet is public.");
                const workbook = window.XLSX.read(csvText, { type: 'string', raw: true });
                const sourceName = allSheetOptions[url] || url;
                processData(workbook, sourceName);
            } catch (err) {
                setError(err.message || "Failed to fetch. Check URL and permissions.");
                console.error(err);
            } finally {
                setIsLoading(false);
            }
        };

        const handleClearFilters = () => setFilters({ auditor: '', agentId: '', tlName: '', site: '', tenure: '', skill: '' });
        
        const handleReset = () => {
            setData([]); setFilteredData([]);
            handleClearFilters();
            setSelectedFileName(null);
            setGoogleSheetUrl('');
            setCustomGoogleSheetUrl('');
            setError(null);
            setInputType(null);
            setCurrentView('dashboard');
            // --- NEW: Clear the saved state from localStorage ---
            localStorage.removeItem('auditDashboardState');
            if(document.getElementById('file-upload')) {
                document.getElementById('file-upload').value = '';
            }
        };
        
        const handleInputTypeSelect = (type) => {
            setInputType(type);
            if (type === 'excel') {
                setGoogleSheetUrl(''); setCustomGoogleSheetUrl('');
            } else if (type === 'googleSheet') {
                setSelectedFileName(null);
                if(document.getElementById('file-upload')) {
                    document.getElementById('file-upload').value = '';
                }
            }
        };

        useEffect(() => {
          let filtered = data.filter(item => findValue(item, ['Status']) === 'TRUE' && findValue(item, ['Status_1']) === 'Done');
          if (filters.auditor) filtered = filtered.filter(item => {
              const auditor = findValue(item, ['Auditor QA', 'Auditor']);
              return auditor && auditor.toLowerCase().includes(filters.auditor.toLowerCase());
          });
          if (filters.agentId) filtered = filtered.filter(item => {
              const agentId = findValue(item, ['Agent ID']);
              return agentId && String(agentId).toLowerCase().includes(filters.agentId.toLowerCase());
          });
          if (filters.tlName) filtered = filtered.filter(item => {
              const tl = findValue(item, ['TL']);
              return tl && tl.toLowerCase().includes(filters.tlName.toLowerCase());
          });
          if (filters.site) filtered = filtered.filter(item => {
              const site = findValue(item, ['Site']);
              return site && site.toLowerCase().includes(filters.site.toLowerCase());
          });
          if (filters.tenure) filtered = filtered.filter(item => {
              const tenure = findValue(item, ['Tenure 2']);
              return tenure && tenure.toLowerCase().includes(filters.tenure.toLowerCase());
          });
          if (filters.skill) filtered = filtered.filter(item => {
              const skill = findValue(item, ['Skill']);
              return skill && skill.toLowerCase().includes(filters.skill.toLowerCase());
          });
          setFilteredData(filtered);
        }, [data, filters]);
        
        const handleViewDetails = () => {
            const titleParts = [];
            if (filters.auditor) titleParts.push(`Auditor: ${filters.auditor}`);
            if (filters.agentId) titleParts.push(`Agent ID: ${filters.agentId}`);
            if (filters.tlName) titleParts.push(`TL: ${filters.tlName}`);
            if (filters.site) titleParts.push(`Site: ${filters.site}`);
            if (filters.tenure) titleParts.push(`Tenure: ${filters.tenure}`);
            if (filters.skill) titleParts.push(`Skill: ${filters.skill}`);

            let title = "Detailed Log";
            if (titleParts.length > 0) {
                title = `Details for ${titleParts.join(', ')}`;
            }

            setDetailData(filteredData);
            setDetailTitle(title);
            setCurrentView('detail');
        };

        const isDetailViewEnabled = useMemo(() => {
            const activeFilters = Object.values(filters).filter(Boolean).length;
            return activeFilters > 0 && filteredData.length > 0;
        }, [filters, filteredData]);


        const totalAudits = filteredData.length;
        const totalCE = filteredData.filter(item => findValue(item, ['CE']) === 'TRUE').length;
        const totalNCE = filteredData.filter(item => findValue(item, ['NCE']) === 'TRUE').length;
        const totalRTC = filteredData.filter(item => findValue(item, ['RTC']) === 'TRUE').length;
        const cePercentage = totalAudits > 0 ? ((totalCE / totalAudits) * 100) : 0;
        const ncePercentage = totalAudits > 0 ? ((totalNCE / totalAudits) * 100) : 0;
        const rtcPercentage = totalAudits > 0 ? (100 - ((totalRTC / totalAudits) * 100)) : 0;
        
        const nceTopics = useMemo(() => {
            const topics = filteredData
                .filter(item => findValue(item, ['NCE']) === 'TRUE')
                .map(item => findValue(item, ['NCE Topic']))
                .filter(topic => topic && topic !== 'N/A');

            const topicCounts = topics.reduce((acc, topic) => {
                acc[topic] = (acc[topic] || 0) + 1;
                return acc;
            }, {});

            return Object.entries(topicCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5)
                .map(([name, value]) => ({ name, value }));
        }, [filteredData]);

        const ceHolders = useMemo(() => Object.entries(filteredData.filter(item => findValue(item, ['CE']) === 'TRUE').map(item => findValue(item, ['Agent ID'])).reduce((acc, holder) => ({...acc, [holder]: (acc[holder] || 0) + 1 }), {})).sort(([,a],[,b]) => b-a).slice(0,5).map(([name, value]) => ({name, value})), [filteredData]);
        const nceHolders = useMemo(() => Object.entries(filteredData.filter(item => findValue(item, ['NCE']) === 'TRUE').map(item => findValue(item, ['Agent ID'])).reduce((acc, holder) => ({...acc, [holder]: (acc[holder] || 0) + 1 }), {})).sort(([,a],[,b]) => b-a).slice(0,5).map(([name, value]) => ({name, value})), [filteredData]);
        
        const requestSort = (key, config, setConfig) => {
            let direction = 'descending';
            if (config.key === key && config.direction === 'descending') {
                direction = 'ascending';
            }
            setConfig({ key, direction });
        };

        const auditorMetrics = useMemo(() => {
            const auditorData = filteredData.reduce((acc, item) => {
                const auditorName = findValue(item, ['Auditor QA', 'Auditor']);
                if (!auditorName) return acc;
                if (!acc[auditorName]) acc[auditorName] = { totalAudits: 0, totalCE: 0, totalNCE: 0, totalRTC: 0 };
                acc[auditorName].totalAudits++;
                if (findValue(item, ['CE']) === 'TRUE') acc[auditorName].totalCE++;
                if (findValue(item, ['NCE']) === 'TRUE') acc[auditorName].totalNCE++;
                if (findValue(item, ['RTC']) === 'TRUE') acc[auditorName].totalRTC++;
                return acc;
            }, {});

            let sortableItems = Object.entries(auditorData).map(([auditor, metrics]) => ({
                name: auditor,
                totalAudits: metrics.totalAudits,
                cePercentage: (metrics.totalAudits > 0 ? (metrics.totalCE / metrics.totalAudits) * 100 : 0),
                ncePercentage: (metrics.totalAudits > 0 ? (metrics.totalNCE / metrics.totalAudits) * 100 : 0),
                rtcAccuracy: (metrics.totalAudits > 0 ? 100 - (metrics.totalRTC / metrics.totalAudits) * 100 : 0),
            }));

            if (auditorSortConfig.key !== null) {
                sortableItems.sort((a, b) => {
                    if (a[auditorSortConfig.key] < b[auditorSortConfig.key]) {
                        return auditorSortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[auditorSortConfig.key] > b[auditorSortConfig.key]) {
                        return auditorSortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            return sortableItems;
        }, [filteredData, auditorSortConfig]);

        const tlMetrics = useMemo(() => {
            const tlData = filteredData.reduce((acc, item) => {
                const tlName = findValue(item, ['TL']);
                if (!tlName) return acc;
                if (!acc[tlName]) acc[tlName] = { totalAudits: 0, totalCE: 0, totalNCE: 0, totalRTC: 0 };
                acc[tlName].totalAudits++;
                if (findValue(item, ['CE']) === 'TRUE') acc[tlName].totalCE++;
                if (findValue(item, ['NCE']) === 'TRUE') acc[tlName].totalNCE++;
                if (findValue(item, ['RTC']) === 'TRUE') acc[tlName].totalRTC++;
                return acc;
            }, {});

            let sortableItems = Object.entries(tlData).map(([tl, metrics]) => ({
                name: tl,
                totalAudits: metrics.totalAudits,
                cePercentage: (metrics.totalAudits > 0 ? (metrics.totalCE / metrics.totalAudits) * 100 : 0),
                ncePercentage: (metrics.totalAudits > 0 ? (metrics.totalNCE / metrics.totalAudits) * 100 : 0),
                rtcAccuracy: (metrics.totalAudits > 0 ? 100 - (metrics.totalRTC / metrics.totalAudits) * 100 : 0),
            }));

            if (tlSortConfig.key !== null) {
                sortableItems.sort((a, b) => {
                    if (a[tlSortConfig.key] < b[tlSortConfig.key]) {
                        return tlSortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[tlSortConfig.key] > b[tlSortConfig.key]) {
                        return tlSortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            return sortableItems;
        }, [filteredData, tlSortConfig]);

        const getAccentColor = (metric, value) => {
            switch (metric) {
                case 'total-audits': return '#4f46e5';
                case 'total-ce': return value > 1 ? '#ef4444' : '#10b981';
                case 'total-nce': return value > 10 ? '#f97316' : '#10b981';
                case 'rtc-accuracy': return value > 90 ? '#10b981' : '#ef4444';
                default: return '#6b7280';
            }
        };
        const getTableCellColor = (value, threshold, isHigherBetter = false) => {
            const isBad = isHigherBetter ? parseFloat(value) < threshold : parseFloat(value) > threshold;
            return isBad ? 'text-red-400' : 'text-green-400';
        };
        
        const SortableHeader = ({ label, sortKey, sortConfig, setSortConfig }) => {
            const isSorted = sortConfig.key === sortKey;
            const icon = isSorted ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : '';
            return (
                <button onClick={() => requestSort(sortKey, sortConfig, setSortConfig)} className="flex items-center justify-center gap-2 font-semibold text-gray-300 hover:text-indigo-400 transition-colors">
                    <span>{label}</span>
                    <span className="text-indigo-400">{icon}</span>
                </button>
            );
        };
        
        if (currentView === 'detail') {
            return (
                <div className="p-4 sm:p-8">
                    <DetailView data={detailData} title={detailTitle} onBack={() => setCurrentView('dashboard')} />
                </div>
            );
        }

        return (
          <div className="p-4 sm:p-8">
            <PinModal 
                isOpen={isPinModalOpen} 
                onClose={() => setIsPinModalOpen(false)} 
                onSubmit={handlePinSubmit}
                pin={pinInput}
                setPin={setPinInput}
                error={pinError}
            />
            <SettingsModal 
                isOpen={isSettingsOpen} 
                onClose={() => setIsSettingsOpen(false)} 
                userSheets={userSheetOptions} 
                onAddSheet={handleAddSheet} 
                onDeleteSheet={handleDeleteSheet} 
                cardVisibility={cardVisibility}
                onVisibilityChange={handleVisibilityChange}
            />
            <div className="max-w-7xl mx-auto space-y-8">
              <header className="glass-card text-white p-6 rounded-2xl shadow-2xl fade-in-down relative">
                <div className="text-center">
                    <h1 className="text-4xl sm:text-5xl font-extrabold tracking-tight">Audit Dashboard</h1>
                    <p className="text-gray-300 mt-2 text-lg">Your data, beautifully visualized.</p>
                </div>
                <button onClick={handleSettingsClick} className="absolute top-4 right-4 text-white p-2 rounded-full hover:bg-white/10 transition-colors pulse-on-hover">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                
                <div className="mt-8 space-y-4">
                    <div className="flex items-center justify-center gap-6">
                        <div onClick={() => handleInputTypeSelect('excel')} className={`flex flex-col items-center justify-center p-4 w-44 h-32 rounded-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-1 ${inputType === 'excel' ? 'bg-white/20 ring-2 ring-white shadow-lg' : 'bg-white/5 hover:bg-white/10'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 7h.01M15 7h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            <span className="mt-2 font-semibold text-white">Excel File</span>
                        </div>
                        <div onClick={() => handleInputTypeSelect('googleSheet')} className={`flex flex-col items-center justify-center p-4 w-44 h-32 rounded-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-1 ${inputType === 'googleSheet' ? 'bg-white/20 ring-2 ring-white shadow-lg' : 'bg-white/5 hover:bg-white/10'}`}>
                           <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-3-3v6m-6 4h12a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                            <span className="mt-2 font-semibold text-white">Google Sheet</span>
                        </div>
                    </div>

                    {inputType === 'excel' && (
                        <div className="flex justify-center w-full max-w-md mx-auto pt-2 fade-in-up" style={{animationDuration: '0.3s'}}>
                            <Input id="file-upload" type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="cursor-pointer file:rounded-md file:bg-blue-500 file:border-0 file:text-white file:font-semibold file:text-sm file:py-2 file:px-4 hover:file:bg-blue-600"/>
                        </div>
                    )}

                    {inputType === 'googleSheet' && (
                        <div className="space-y-2 w-full max-w-xl mx-auto pt-2 fade-in-up" style={{animationDuration: '0.3s'}}>
                            <select value={googleSheetUrl} onChange={e => { const url = e.target.value; setGoogleSheetUrl(url); if (url !== "custom" && url !== "") { handleUrlLoad(url); }}} className="h-10 w-full rounded-md border border-gray-700 bg-black/20 px-3 py-2 text-sm text-gray-200 ring-offset-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                {Object.entries(allSheetOptions).map(([url, name]) => ( <option key={url} value={url} className="bg-gray-800 text-gray-200">{name}</option>))}
                            </select>
                            {googleSheetUrl === 'custom' && (
                                <div className="flex items-center justify-center gap-2 w-full fade-in-up" style={{animationDuration: '0.3s'}}>
                                    <Input type="text" value={customGoogleSheetUrl} onChange={e => setCustomGoogleSheetUrl(e.target.value)} placeholder="Paste public CSV URL and press Load" className="w-full"/>
                                    <Button onClick={() => handleUrlLoad(customGoogleSheetUrl)} className="flex-shrink-0">Load</Button>
                                </div>
                            )}
                        </div>
                    )}

                    {isLoading && (
                        <div className="flex items-center justify-center space-x-2 text-white mt-4">
                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full spinner"></div>
                            <span>Loading Data...</span>
                        </div>
                    )}
                    {!isLoading && error && (
                        <div className="flex items-center justify-center space-x-4 bg-red-900/50 p-2 rounded-lg max-w-md mx-auto mt-4">
                            <p className="text-sm text-white truncate">Error: {error}</p>
                        </div>
                    )}
                    {!isLoading && !error && selectedFileName && (
                        <div className="flex items-center justify-center space-x-2 bg-black/30 p-2 rounded-lg max-w-md mx-auto mt-4">
                            <p className="text-sm text-white truncate">Loaded: <span className="font-semibold">{selectedFileName}</span></p>
                        </div>
                    )}
                </div>
              </header>
              
              {(data.length > 0 || isLoading) && (
                <main className="space-y-8 fade-in-up">
                  <Card accentColor="#4f46e5">
                    <CardHeader><CardTitle>Filter Your Data</CardTitle></CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div className="space-y-1"><Label>Auditor</Label>
                            <SearchableInput 
                                key={`auditor-${cascadingOptions.auditors.join('')}`}
                                id="auditor-list" 
                                value={filters.auditor} 
                                onChange={e => setFilters(p => ({...p, auditor: e.target.value}))} 
                                options={cascadingOptions.auditors} 
                                placeholder="Search Auditor..."/>
                        </div>
                        <div className="space-y-1"><Label>Agent ID</Label>
                            <SearchableInput 
                                key={`agentId-${cascadingOptions.agentIds.join('')}`}
                                id="agent-list" 
                                value={filters.agentId} 
                                onChange={e => setFilters(p => ({...p, agentId: e.target.value}))} 
                                options={cascadingOptions.agentIds} 
                                placeholder="Search Agent ID..."/>
                        </div>
                        <div className="space-y-1"><Label>TL Name</Label>
                            <SearchableInput 
                                key={`tlName-${cascadingOptions.tlNames.join('')}`}
                                id="tl-list" 
                                value={filters.tlName} 
                                onChange={e => setFilters(p => ({...p, tlName: e.target.value}))} 
                                options={cascadingOptions.tlNames} 
                                placeholder="Search TL Name..."/>
                        </div>
                        <div className="space-y-1"><Label>Site</Label>
                            <SearchableInput 
                                key={`site-${cascadingOptions.sites.join('')}`}
                                id="site-list" 
                                value={filters.site} 
                                onChange={e => setFilters(p => ({...p, site: e.target.value}))} 
                                options={cascadingOptions.sites} 
                                placeholder="Search Site..."/>
                        </div>
                        <div className="space-y-1"><Label>Tenure</Label>
                            <SearchableInput 
                                key={`tenure-${cascadingOptions.tenures.join('')}`}
                                id="tenure-list" 
                                value={filters.tenure} 
                                onChange={e => setFilters(p => ({...p, tenure: e.target.value}))} 
                                options={cascadingOptions.tenures} 
                                placeholder="Search Tenure..."/>
                        </div>
                        <div className="space-y-1"><Label>Skill</Label>
                            <SearchableInput 
                                key={`skill-${cascadingOptions.skills.join('')}`}
                                id="skill-list" 
                                value={filters.skill} 
                                onChange={e => setFilters(p => ({...p, skill: e.target.value}))} 
                                options={cascadingOptions.skills} 
                                placeholder="Search Skill..."/>
                        </div>
                      </div>
                      <div className="mt-4 flex justify-end gap-4">
                          <Button onClick={handleViewDetails} disabled={!isDetailViewEnabled} className="from-green-500 to-teal-400 hover:from-green-600 hover:to-teal-500 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:opacity-70">
                              View Details
                          </Button>
                          <Button onClick={handleClearFilters} className="from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500">
                              Clear Filters
                          </Button>
                          {data.length > 0 && (
                            <Button onClick={handleReset} className="from-red-600 to-pink-500 hover:from-red-700 hover:to-pink-600">
                                Reset Data
                            </Button>
                          )}
                      </div>
                    </CardContent>
                  </Card>
                  
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                    <Card accentColor={getAccentColor('total-audits')}><CardHeader><CardTitle>Total Audits</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-indigo-400"><AnimatedNumber value={totalAudits} /></div></CardContent></Card>
                    <Card accentColor={getAccentColor('total-ce', cePercentage)}><CardHeader><CardTitle>Total CE</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-red-400"><AnimatedNumber value={totalCE} /></div><p className="text-sm text-gray-400"><AnimatedNumber value={cePercentage} isPercentage={true} /></p></CardContent></Card>
                    <Card accentColor={getAccentColor('total-nce', ncePercentage)}><CardHeader><CardTitle>Total NCE</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-orange-400"><AnimatedNumber value={totalNCE} /></div><p className="text-sm text-gray-400"><AnimatedNumber value={ncePercentage} isPercentage={true} /></p></CardContent></Card>
                    <Card accentColor={getAccentColor('rtc-accuracy', rtcPercentage)}><CardHeader><CardTitle>RTC Accuracy</CardTitle></CardHeader><CardContent><div className="text-4xl font-bold text-green-400"><AnimatedNumber value={rtcPercentage} isPercentage={true} /></div></CardContent></Card>
                  </div>
                  
                  {cardVisibility.auditorPerformance && <CollapsibleCard title="Auditor Performance Breakdown" accentColor="#3b82f6">
                      <div className="grid grid-cols-6 gap-4 px-4 py-2 border-b-2 border-gray-700 text-sm text-center">
                          <div className="text-left font-semibold text-gray-300 col-span-2">Auditor</div>
                          <SortableHeader label="Total Audits" sortKey="totalAudits" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="CE %" sortKey="cePercentage" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="NCE %" sortKey="ncePercentage" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                          <SortableHeader label="RTC Accuracy %" sortKey="rtcAccuracy" sortConfig={auditorSortConfig} setSortConfig={setAuditorSortConfig} />
                      </div>
                      <div className="space-y-2 mt-2">
                          {auditorMetrics.map((auditor, index) => (
                              <div key={auditor.name} className="grid grid-cols-6 gap-4 items-center p-3 rounded-lg hover:bg-white/5 hover:shadow-md transition-all duration-200 fade-in-up" style={{ animationDelay: `${index * 50}ms`, opacity: 0 }}>
                                  <div className="col-span-2 flex items-center gap-3">
                                      <span className="font-bold text-indigo-300 bg-indigo-900/50 rounded-full w-8 h-8 flex items-center justify-center">{index + 1}</span>
                                      <span className="font-semibold text-gray-200 truncate">{auditor.name}</span>
                                  </div>
                                  <div className="text-center font-bold text-gray-300">{auditor.totalAudits}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(auditor.cePercentage, 1)}`}>{auditor.cePercentage.toFixed(2)}%</div>
                                  <div className={`text-center font-bold ${getTableCellColor(auditor.ncePercentage, 10)}`}>{auditor.ncePercentage.toFixed(2)}%</div>
                                  <div className={`text-center font-bold ${getTableCellColor(auditor.rtcAccuracy, 90, true)}`}>{auditor.rtcAccuracy.toFixed(2)}%</div>
                              </div>
                          ))}
                      </div>
                  </CollapsibleCard>}

                  {cardVisibility.tlPerformance && <CollapsibleCard title="TL Performance Breakdown" accentColor="#10b981">
                      <div className="grid grid-cols-6 gap-4 px-4 py-2 border-b-2 border-gray-700 text-sm text-center">
                          <div className="text-left font-semibold text-gray-300 col-span-2">Team Lead</div>
                          <SortableHeader label="Total Audits" sortKey="totalAudits" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="CE %" sortKey="cePercentage" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="NCE %" sortKey="ncePercentage" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                          <SortableHeader label="RTC Accuracy %" sortKey="rtcAccuracy" sortConfig={tlSortConfig} setSortConfig={setTlSortConfig} />
                      </div>
                      <div className="space-y-2 mt-2">
                          {tlMetrics.map((tl, index) => (
                              <div key={tl.name} className="grid grid-cols-6 gap-4 items-center p-3 rounded-lg hover:bg-white/5 hover:shadow-md transition-all duration-200 fade-in-up" style={{ animationDelay: `${index * 50}ms`, opacity: 0 }}>
                                  <div className="col-span-2 flex items-center gap-3">
                                      <span className="font-bold text-green-300 bg-green-900/50 rounded-full w-8 h-8 flex items-center justify-center">{index + 1}</span>
                                      <span className="font-semibold text-gray-200 truncate">{tl.name}</span>
                                  </div>
                                  <div className="text-center font-bold text-gray-300">{tl.totalAudits}</div>
                                  <div className={`text-center font-bold ${getTableCellColor(tl.cePercentage, 1)}`}>{tl.cePercentage.toFixed(2)}%</div>
                                  <div className={`text-center font-bold ${getTableCellColor(tl.ncePercentage, 10)}`}>{tl.ncePercentage.toFixed(2)}%</div>
                                  <div className={`text-center font-bold ${getTableCellColor(tl.rtcAccuracy, 90, true)}`}>{tl.rtcAccuracy.toFixed(2)}%</div>
                              </div>
                          ))}
                      </div>
                  </CollapsibleCard>}

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {cardVisibility.topCeHolders && <CollapsibleCard title="Top 5 CE Holders" accentColor="#ef4444">
                        <div className="h-64"><BarChart data={ceHolders} barColor="linear-gradient(to right, #ef4444, #dc2626)" /></div>
                    </CollapsibleCard>}
                    {cardVisibility.topNceHolders && <CollapsibleCard title="Top 5 NCE Holders" accentColor="#f97316">
                        <div className="h-64"><BarChart data={nceHolders} barColor="linear-gradient(to right, #f97316, #fbbf24)" /></div>
                    </CollapsibleCard>}
                    {cardVisibility.topNceTopics && <CollapsibleCard title="Top 5 NCE Topics" accentColor="#f97316" defaultMinimized={true}>
                        <div className="h-64"><BarChart data={nceTopics} barColor="linear-gradient(to right, #f97316, #fbbf24)" /></div>
                    </CollapsibleCard>}
                  </div>
                </main>
              )}
              <footer className="text-center py-6 mt-4">
                  <div className="flex items-center justify-center text-gray-400">
                      <p className="text-sm font-semibold">Created By MD Ariful Islam Khan</p>
                  </div>
              </footer>
            </div>
          </div>
        );
      };
      
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);

    </script>
</body>
</html>
